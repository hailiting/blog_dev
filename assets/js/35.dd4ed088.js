(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{419:function(t,a,s){t.exports=s.p+"assets/img/2021.01.28.54c68a87.png"},709:function(t,a,s){"use strict";s.r(a);var n=s(44),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,n=t._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"react-事件绑定原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#react-事件绑定原理"}},[t._v("#")]),t._v(" React 事件绑定原理")]),t._v(" "),n("h2",{attrs:{id:"今日解题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#今日解题"}},[t._v("#")]),t._v(" 今日解题")]),t._v(" "),n("p",[t._v("React 并不是将 click 事件绑定在该 div 的真实 DOM 上，而是在 document 处监听所有支持的事件，当事件发生并冒泡至 document 处时，React 将事件内容封装并交由真正的处理函数运行。这样的方式不仅减少内存消耗，还能在组件挂载销毁时统一订阅和移除事件。"),n("br"),t._v("\n另外冒泡到 document 上的事件也不是原生浏览器事件，而是 React 自己实现的合成事件(SyntheticEvent)。因此我们如果不需要事件冒泡的话，调用"),n("code",[t._v("event.stopPropagation")]),t._v("是无效的，而应该调用"),n("code",[t._v("event.preventDefault")]),t._v("。")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("div ---事件冒泡至顶层---\x3e 监听 document 事件 -----\x3e实例化成统一的ReactEvent事件【SyntheticEvent】----\x3eevent对象交由对应的处理器执行【handle1, handle2....】\n")])])]),n("h3",{attrs:{id:"具体的几个阶段"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#具体的几个阶段"}},[t._v("#")]),t._v(" 具体的几个阶段")]),t._v(" "),n("ul",[n("li",[n("ol",[n("li",[t._v("事件注册")])])]),t._v(" "),n("li",[n("ol",{attrs:{start:"2"}},[n("li",[t._v("事件存储")])])]),t._v(" "),n("li",[n("ol",{attrs:{start:"3"}},[n("li",[t._v("事件触发执行")])])]),t._v(" "),n("li",[n("ol",{attrs:{start:"4"}},[n("li",[t._v("合成事件")])])])]),t._v(" "),n("h4",{attrs:{id:"事件注册"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#事件注册"}},[t._v("#")]),t._v(" 事件注册")]),t._v(" "),n("ul",[n("li",[t._v("组件转载/更新【_updateDOMProperties】")]),t._v(" "),n("li",[t._v("通过 lastProps、nextProps 判断是否新增、删除事件分别调用事件注册、卸载方法")]),t._v(" "),n("li",[t._v("调用 EventPluginHub 的 enqueuePutListener 进行事件存储")]),t._v(" "),n("li",[t._v("获取 document 对象")]),t._v(" "),n("li",[t._v("根据事件名称（如：onClick、onCaptureClick）判断是进行冒泡还是捕获")]),t._v(" "),n("li",[t._v("判断是否存在 addEventListener 方法，否则使用 attachEvent（兼容 IE）")]),t._v(" "),n("li",[t._v("给 document 注册原生事件回调为 dispatchEvent")])]),t._v(" "),n("h3",{attrs:{id:"事件存储"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#事件存储"}},[t._v("#")]),t._v(" 事件存储")]),t._v(" "),n("ul",[n("li",[t._v("EventPluginHub 负责管理 React 合成事件的 callback，它将 callback 存储在 ListenerBank 中，另外还存储了负责合成事件的 Plugin。")]),t._v(" "),n("li",[t._v("EventPluginHub 的 putListener 方法是向存储容器中增加一个 listener")]),t._v(" "),n("li",[t._v("获取绑定事件元素的唯一标识 Key")]),t._v(" "),n("li",[t._v("将 callback 根据事件类型，元素的唯一标识 key 存储在 listenerBank 中")]),t._v(" "),n("li",[t._v("listenerBank 的结构是："),n("code",[t._v("listenerBank[registrationName][key]")])])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  onClick"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("nodeid1")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("nodeid2")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  onChange"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("nodeid3")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("nodeid4")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h3",{attrs:{id:"事件触发"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#事件触发"}},[t._v("#")]),t._v(" 事件触发")]),t._v(" "),n("ul",[n("li",[t._v("触发 document 注册原生事件的回调 dispatchEvent")]),t._v(" "),n("li",[t._v("获取到触发这个事件最深一级的元素")])]),t._v(" "),n("p",[t._v("【这里的事件执行利用了 React 的批处理机制】")]),t._v(" "),n("div",{staticClass:"language-jsx extra-class"},[n("pre",{pre:!0,attrs:{class:"language-jsx"}},[n("code",[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("onClick")]),n("span",{pre:!0,attrs:{class:"token script language-javascript"}},[n("span",{pre:!0,attrs:{class:"token script-punctuation punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("parentClick"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("ref")]),n("span",{pre:!0,attrs:{class:"token script language-javascript"}},[n("span",{pre:!0,attrs:{class:"token script-punctuation punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ref")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("parent "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ref"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),n("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n  ")]),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("onClick")]),n("span",{pre:!0,attrs:{class:"token script language-javascript"}},[n("span",{pre:!0,attrs:{class:"token script-punctuation punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("childClick"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("ref")]),n("span",{pre:!0,attrs:{class:"token script language-javascript"}},[n("span",{pre:!0,attrs:{class:"token script-punctuation punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ref")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("child "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ref"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),n("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n    test\n  ")]),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),n("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n")]),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// -1 首先会获取到this.child")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// -2 遍历这个元素的所有父元素，依次对每一级元素进行处理")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// -3 构造合成事件")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// -4 将每一级合成事件存储在eventQueue事件队列中")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// -5 遍历eventQueue")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// -6 通过isPropagationStopped判断当前事件是否执行了阻止冒泡的方法")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// -7 如果阻止了冒泡，停止遍历，否则通过executeDispatch执行合成事件")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// -8 释放处理完的事件")]),t._v("\n")])])]),n("h3",{attrs:{id:"合成事件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#合成事件"}},[t._v("#")]),t._v(" 合成事件")]),t._v(" "),n("ul",[n("li",[t._v("调用 EventPluginHub 的 extractEvents 方法")]),t._v(" "),n("li",[t._v("循环所有类型的 EventPlugin（用来处理不同事件的工具方法）")]),t._v(" "),n("li",[t._v("在每个 EventPlugin 中根据不同的事件类型，返回不同发事件池")]),t._v(" "),n("li",[t._v("在事件池中取出合成事件，如果事件池是空，那么创建一个新的")]),t._v(" "),n("li",[t._v("根据元素 nodeid（唯一标识 key）和事件类型从 listenerBink 中取出回调函数")]),t._v(" "),n("li",[t._v("返回带有合成事件参数的回调函数")])]),t._v(" "),n("p",[n("img",{attrs:{src:s(419),alt:"2021.01.28"}})])])}),[],!1,null,null,null);a.default=e.exports}}]);