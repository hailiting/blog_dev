# 操作系统 存储管理

## 虚拟内存原理

虚拟内存实际上是对物理内存的补充，速度接近于内存，成本接近于辅存  
虚拟内存的容量只受计算机地址位数限制

### 产生原因

- 有些进程实际需要的内存很大，超过物理内存的容量
- 多道程序设计，使得每个进程可用物理内存更加稀缺
- 不可能无限增加物理内存，物理内存总有不够的时候

### 概述

- 虚拟内存是操作系统内存管理的关键技术
- 使得多道程序运行和大程序运行成为现实
- 把程序使用内存划分，将部分暂时不使用的内存放置在辅存

- 程序运行时，无需全部装入内存，装载部分即可
- 如果访问页不在内存，则发出缺页中断，发起页面置换
- 从用户层面看，程序拥有很大的空间，即虚拟内存

- 替换策略发生在`Cache-主存层次`、主存-辅存层次
- `Cache-主存层次`的替换策略主要是为了解决速度问题
- 主存-辅存层次主要是为了解决容量问题

#### **逻辑地址空间**

- 逻辑地址空间是指进程可以使用的内存空间
- 逻辑地址空间的大小仅受 CPU 地址长度限制
- 32 位地址最大逻辑空间为 4G
- 逻辑地址空间是一个进程运行时程序指令与程序数据可以用的相对地址空间

#### **物理地址空间**

- 物理地址指向物理内存的存储空间
- 物理地址空间是指程序运行过程在物理内存分配和使用的地址空间

## 存储器层次结构

- 局部性原理，有什么应用
  - 局部性原理是指 CPU 访问存储器时，无论是存取指令还是存取数据，所访问的存储单位都趋于聚集在一个较小的连续区域中
    - CPU -> 高速缓存 -> 主存 -> 辅存
    - 缓存-主存层次（局部性原理）-> 解决主存速度不足问题
      - 实现：在 CPU 与主存之间增加一层速度快（容量小）的 Cache
    - 主存-辅存层次（局部性原理）-> 解决主存容量不足的问题
      - 实现：主存之外增加辅助存储器（磁盘、SD 卡、U 盘等）
    - 缓存设计
      - 分离冷热数据，降低热点数据服务的负载
      - 提升吞吐量、并发量，提升服务质量
- 存储器可以分为寄存器、主存、辅存
  - 缓存：速度快，位价高
  - 主存：速度适中，位价适中
  - 辅存：速度慢，位价低
- 位价
  - 每比特位的价格

## 段页式存储管理

- 操作系统缺页中断
- 什么是内存页，Linux 的内存页一般多大

### 内存管理

- 页式存储管理
  - 将进程逻辑空间等分成若干大小的页面
  - 相应的把物理内存空间分成与页面大小的物理块
  - 以页面为单位把进程空间装进物理内存中分散的物理块
    - 页面大小应该适中，过大难以分配，过小页表管理空间大
    - 页面的大小通常是 512B-8K
      - linux => 4k
  - 缺点：有一段连续的逻辑发布在多个页面中，将大大降低执行效率
- 段式存储管理
  - 将进程逻辑空间划分为若干段（非等分）
  - 段的长度由连续逻辑的长度决定
  - 主函数 MAIN、子程序段 X、子函数 Y 等
    - 段表：段号，基址，段长
    - 段号
    - 段内偏移
  - 段式存储管理相比页式存储管理更加灵活
- 段页式存储管理

  - 分页管理有效提高内存利用率
  - 分段管理更加灵活
    - 先将逻辑空间按段式管理分成若干段
    - 再把段内空间按页式管理等分成若干页
    - 页地址、段地址、段页地址

- 缺页中断
  - 磁盘属于外设，读写磁盘需要系统调用
  - 保护 CPU 现场->分析中断原因->中断处理->恢复 CPU 环境
  - 在指令执行期间产生和处理中断信号
  - 一条指令执行期间，可能产生多次缺页中断
    symbol: BTC, size: 100, page: 1, interval: 15m
    页表 - 记录进程逻辑空间与物理空间的映射

## 页面置换算法

- LRU 缓存置换算法
- LFU 缓存置换算法

### 页面置换的时机

- 高速缓存替换的时机 - 【CPU】<->【高速缓存(缓存没有数据)】<-需要从主存载入所需数据->【主存】
- 主存页面的替换时机 - 【CPU】<->【高速缓存】<->【主存(主存没有数据)】<-需要从辅存载入所需数据->辅存

### 双向链表

- 单向链表：每一个节点都有下一个节点的地址或引用
- 双向链表：每一个节点都有上一个节点和下一个节点的地址和引用
  - 可以快速找到一个节点的下一个节点
  - 可以快速找到一个节点的上一个节点
  - 快速去掉链表中的某一个节点【$O_1$】
- 先进先出算法(FIFO)
- 最不经常使用算法(LFU) Least Frequently Used
  - 优先淘汰最不经常使用的字块
  - 需要额外的空间记录字块的使用频率
- 最近最少使用算法(LRU) Least Recently Used
  - 优先淘汰一段时间内没有使用的字块
  - 有多种实现方法，一般使用双向链表
  - 把当前访问节点置于链表前面（保证链表头部节点是最近使用的）

## Linux 文件系统

- Linux 的软链接与硬链接
  - 具有相同 iNode 节点号的文件互为硬链接文件
  - 删除硬链接文件或删除源文件任意之一，文件实体并未被删除
  - 软链接类似 Windows 系统的快捷方式
  - 软链接里存放的是源文件的路径，指向源文件
  - 删除源文件，软链接依然存在，但无法访问源文件内容
- Linux 文件系统 Inode 的理解

### 常见文件系统

#### FAT

- FAT - File Allocation Table
- FAT16, FAT32 等，微软 DOS/Windows 使用的文件系统
- 使用一张表保存盘块的信息

#### NTFS

- NTFS - New Technology File System
- WindowsNT 环境的文件系统
- NTFS 对 FAT 进行改进，取代了旧的文件系统

#### ext

- Linux 文件系统
- EXT - Extended file system, 扩展文件系统
- Linux 的文件系统
- EXT2/3/4 数字表示第几代
- Boot Sector：启动扇区，安装开机管理程序
- Block Group：块组，存储数据的实际位置
  - Superblock
    - 记录文件系统相关信息
    - Block 与 iNode 的使用情况
    - 时间信息和控制信息
  - 文件系统描述
  - Inode bitmap
    - Inode 位示图
    - 记录已分配的 INode 和未分配的 Inode
  - Block bitmap
  - Inode table
    - 存放文件 INode 的地方
    - 每一个文件（目录）都有一个 Inode
    - 是每一个文件（目录）的索引节点
    - 文件名不是存放在 INode 节点上的，而是存放在目录的 iNode 节点
    - 列出目录文件的时候无需加载文件 Inode
  - Data block
    - 存放文件内容的地方

## RAID 存储 —— 磁盘冗余阵列

- 什么是服务器 RAID 存储 RAID 是什么
  - RAID(Redundant Array of Independent Disks): 磁盘冗余阵列
    - 利用虚拟化存储技术把多个硬盘组合起来，成为一个或多个硬盘阵列组，目的是为了提升性能或减少冗余，或两者同时提升
- RAID0, RAID1, RAID5 有啥区别
  - RAID0
    - 性能：单块磁盘的 N 倍
    - 不提供数据校验和数据冗余
    - 某块磁盘损坏，数据直接丢失且无法恢复
  - RAID1
    - 数据无差别双写工作磁盘和镜像磁盘
    - 性能：单块磁盘的 N/2 倍
    - 数据可靠性强，只要不是同时损坏，都可以恢复
  - RAID5
    - 数据中心最常见的 RAID 等级
    - 提供纠错海明码实现数据冗余校验
    - 分散校验盘，提高写性能，降低校验盘出错概率
  - REID10
    - REID0 和 REID1 结合体
    - 即保证数据冗余又保证读写效率
    - 磁盘空间存储冗余，浪费
