# 操作系统-调度管理

- 无操作系统的时代 -> 批处理系统的时代 -> 分时系统的时代
- 在单一处理器上，将执行时间有重叠的几个程序称为并行程序

### 多道程序设计

- 多道程序设计是指在计算机内存中同时存放多个程序
- 多道程序在计算机的管理程序下相互穿插运行
- 操作系统实现了对计算机硬件资源的管理与抽象
  - 操作系统（用户无需面向硬件接口编程）
    - 处理器资源
    - 存储器资源
    - IO 设备资源
    - 文件资源
- 问题 ---> 操作系统需要进程
  - 如何隔离不同程序需要使用的计算机资源
  - 操作系统如何进行不同程序的调度
  - 操作系统如何提升计算机资源的利用率与复用率

## 进程

- 在操作系统中，同时存在多个进程，进程之间可以共享允许共享的系统资源
- 为什么需要进程
  - 进程是系统进行资源分配和调度的基本单位
  - 进程作为程序独立运行的载体保障程序正常执行
  - 进程的存在使得操作系统资源的利用率大幅度提升

### 进程的形态

```
进程控制块（数据结构）
  可分为
    进程标识符
    处理机状态
    进程调度信息
    进程控制消息

状态  上下文数据  标识符
优先级  IO状态消息  程序计数器
记账信息     内存指针
```

### 进程的状态模型 —— 同步与异步的区别

- 阻塞、非阻塞、同步、异步
  - 同步与异步强调的是消息通信机制
  - 阻塞和非阻塞强调的是程序在等待调用结果时的状态
- 为什么进程会发送阻塞

- 五状态模型 -> 创建、【就绪、阻塞、运行】、终止
  - 创建
    - 分配 PCB -> 插入就绪队列 （Process Control Block）
    - 创建进程时拥有 PCB 但其他资源尚未就绪的状态称为创建状态
    - 操作系统提供 fork 函数接口创建进程
  - 就绪
    - 当进程被分配到除 CPU 以外所有必要的资源后
    - 只要再获得 CPU 的使用权，就可以立即运行
    - 其他资源都准备好、只差 CPU 资源的状态为就绪状态
  - 执行状态
    - 进程获得 CPU，其程序正在执行称为执行状态
    - 在单处理机中，在某个时刻只能有一个进程是处于执行状态
  - 阻塞状态
    - 进程因某种原因如：其他设备未就绪而无法继续执行
    - 从而放弃 CPU 的状态称为阻塞状态
  - 终止
    - 系统清理 -> PCB 归还

## 线程

CPU 一个核上运行的是一个线程，而不是进程

### 进程与线程的区别

- 进程是`系统进行资源分配和调度的基本单位`
- 进程作为程序`独立运行的载体保障程序正常执行`
- 进程的存在`使得操作系统资源的利用率大幅提升`

### 线程：提高系统内程序并发执行的程度

- 线程是操作系统进行运行调度的最小单位
- 包含在进程之中，是进程中实际运行工作的单位
- 一个进程可以并发多个线程，一个线程执行不同任务

**进程的线程共享进程资源**

## 用户态 vs 内核态

- 操作系统的内核态
- 进程什么时候会进入内核态

- 关键程序在内核态
- 用户编写的程序在用户态

### 内核态

- 内核空间：存放的是内核代码和数据
- 进程执行操作系统内核的代码
- CPU 可以访问内存所有数据，包括外围设备

### 用户态

- 用户空间：存放的是用户程序的代码和数据
- 进程在执行用户自己的代码（非系统调用之类的函数）
- CPU 只能访问有限内存，不允许访问外设（磁盘 网卡 键盘 显示器等）

### 什么情况下内核态和用户态切换

- 系统调用
- 异常中断
- 外围设备中断

intel meltdown 漏洞

## IO 密集 vs 计算密集型（CPU bound）

### CPU bound

- 计算密集型
- 完成一项任务的时间取决于 CPU 的速度
- CPU 利用率高、其他事情处理慢
- 对处理器要求高，存储器要求低

### IO 密集型任务

- 频繁读写网络、磁盘等任务都属于 IO 密集型任务
- 完成一项任务的时间取决于 IO 设备的速度
- CPU 利用率低、大部分时间在等待设备完成

### IO 密集型任务部署时，应该注意什么

CPU 内存 磁盘

```
16核 128G SATA/SSD
56核 128G SATA
72核 512G SSD
```

## 协程(Coroutione)

微线程、纤程、协作式线程

- 多协程可以发挥多核 CPU 的优势吗
- 上下文(`2us~5us  5us*4w/1000/8 = 25ms`)

  - 寄存器级上下文
  - 用户级上下文
  - 系统级上下文

- 协程为什么叫做协作式线程
  - 由用户自行调度，内核无法干涉
- 协程的优点
  - 调度、切换、管理更加轻量
    - 可以减少上下文切换成本
  - 内核无法感知协程的存在
    - 无法发挥 CPU 的多核优势
  - 协程主要运行在多 IO 的场景（网络 IO）
