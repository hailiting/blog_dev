# TCP 协议

TCP 协议提供的是面向连接的可靠传输服务

## TCP 功能

- 可靠传输
- 流量控制
- 拥塞控制

- 窗口
  - 2 个字节 - [0, 65535]
  - 窗口指明允许对方发送的数据量
  - 数据缓冲空间有限，不能无限缓存数据

```
  16位源端口                  16位目的端口
                   序号
                  确认号
数据偏移 保留字段 控制位           窗口
        校验和                紧急指针
        TCP选项（可选）             填充
```

- URG Urgent: 紧急位，URG=1 表示紧急数据
- ACK Acknowledgement: 确认位，ACK=1，确认好才生效
- PSH Push: 推送位，PSH=1 尽快地把数据交付给应用层
- RST Reset: 重置位，RST=1 重新建立连接
- SYN Synchronization: 同步位，SYN=1 表示连接请求报文
- FIN Finish: 终止位，FIN=1 表示释放连接

## 三次握手，四次挥手

## TCP 协议滑动窗口的工作过程——TCP 的可靠传输原理

- `停止-等待协议`
- 滑动窗口，累计确认机制 提高信道的利用率

### 连续 ARQ(Automatic Repeat reQuest)协议

- `停止-等待协议`是最简单的可靠传输协议
- `停止-等待协议`对信道的利用效率不高(串行连接)

### 滑动窗口，累计确认

- 已确认的字节序号
- 已发送未确认
- 不允许发送的字节序号
- 可用窗口

#### 滑动窗口

- 1. 窗口指明允许对方发送的数据量
- 2. TCP 协议是传输数据流的协议，通过 TCP 协议头部序列号，确认号，以及窗口等字段控制，可以在有限的缓冲资源下，接收几乎无限的数据

## TCP 拥塞避免算法

目的： 防止过多数据注入到网络，避免网络中的路由器或链路过载

- 常见的 TCP 拥塞避免算法

### 网络拥塞

- 在某段时间内，若对网络中的某一资源（宽带、缓存、处理机等）的需求超过了该资源所能提供的可用部分，网络性能就会变坏，这种情况下称为网络拥塞
- 拥塞避免是全局角度的问题

### 慢开始与拥塞避免

- 拥塞窗口(cwnd Congestion windo): 拥塞窗口是 TCP 协议基于窗口的拥塞控制需要的一个变量配置。发送方在发送数据时会维持一个叫拥塞窗口的状态变量，并且可以动态变化，在 TCP 报文头部，发送方让自己的发送窗口等于拥塞窗口
- 门限值(ssthresh): 拥塞避免算法启动阈值，当拥塞窗口 cwnd 超过门限值 ssthresh 时，启动慢启动算法
- 传输轮次(Route-Trip): 一次报文发送和确认的时间称为一次传输轮次，RTT(Route-Trip time)定义的是一次传输轮次的往返时间

**门限值(ssthresh) = 拥塞窗口(cwnd)/2**

### 快重传与快恢复

- 快重传：让发送方尽早知道个别报文段的丢失，并立即重传，以避免发送方认为网络发生了拥塞，从而因为拥塞避免算法降低发送数据
  - 不是捎带确认，而是立即确认
- 快重传 -> 门限值(ssthresh) -> 拥塞避免算法
  - 拥塞窗口(cwnd) = 门限值(ssthresh)

## TCP 粘包原理

- TCP 协议数据传输的核心机制——基于字节流，不存在消息、数据包的概念
- TCP 粘包是应用层开发者错误设计实现导致的
- 应用层协议需要自信设计消息边界，以正确分离消息，避免消息粘连
- 分离消息的两个方法：基于长度的拆分、基于特殊字符的拆分
- Nagle 算法时通过合并字节流数据，减少数据包来提升 TCP 协议传输功能的协议

### TCP 协议与应用层协议

- 应用层众多协议使用了 TCP 作为传输层协议
- TCP 协议解决的是传输的可靠性和顺序问题
- TCP 协议是面向节流的数据传输协议
  - 它可能会组合或拆分应用层协议数据
  - 粘包并不是 TCP 协议造成的，而是应用层协议设计缺陷导致的问题

### 解决方法

- 基于长度的标识
- 基于特殊分割符

### **Nagle 算法**

- Nagle 算法是一种通过减少数据包的方式提高 TCP 传输性能算法
- 因为网络宽带有限，它不会将小的数据块直接发送到目的主机，而是会在本地缓冲区中等待更多待发送的数据，这种批量发送数据的策略虽然会影响实时性和网络延迟，但能够减低网络拥堵的可能性并减少额外开销

**Telnet 协议**
**Header(40 字节) + 数据(1 字节)**

- 缓冲区中数据超过最大数据段（MSS）
- 上一个数据段被确认(ACK)后

### 面向 TCP 编程

```js
socket.send("abcd");
data = socket.recv(1024);
```

## SYN Flood 攻击 - TCP 协议安全性详解

### SYN Flood 攻击原理

- 利用三次握手的过程漏洞
- 大量发送第一次握手（假 IP）的报文
- 攻击方忽略第二次握手的报文
- 被攻击方多个 TCP 连接处于（SYNC-RCVD）阶段，耗费大量资源
- 最终因为资源耗尽，拒绝服务（DoS）

### 资源耗尽攻击

- 攻击方控制大量"肉鸡"
- 向攻击目标发送大量连接握手报文
- 完成三次握手后保持连接，但不做任何事情，消耗 TCP 连接资源
- 或者马上断开连接又重新发起连接

### 协议特性漏洞漏洞

- 攻击方控制大量"肉鸡"
- 攻击方与攻击目标建立正常连接
- 依据 TCP 流量控制的特性，马上将 TCP 窗口设置为 0
- 攻击方断开连接，此时攻击目标还傻傻等待窗口重新打开
- 服务器不堪重负，最终影响正常服务或直接宕机

### 防范手段

- 识别异常流量
- 分流异常流量
- 高可用服务部署
- 合理设置参数
- 实时监控告警

## VPN 原理——虚拟专用网技术详解

- 数据隧道
- 专用 IP 地址
- 协议

加密通信的电话，加密通信网络通信

- 一些机构组织不需要所有计算机都接入网络
- 机构成员跨地域通信存在加密安全的需求
  - 公司内网
  - 校园网
  - 工业专用网

### 专用的 IP 地址

- 专用 IP 地址是指一些只能提供机构内部通信的 IP 地址；这类 IP 地址不能接入到互联网上与其他网络主机进行通信
  - 专用 IP 地址只能用作本地地址而不能用作全球地址，因为专用 IP 地址在全球并不是唯一的，互联网上的路由器对目的地址为专用 IP 地址的数据报一律不进行转发
  - A `10.0.0.0 ~ 10.255.255.255`
  - B `127.16.0.0 ~ 127.31.255.255`
  - C `192.168.0.0 ~ 192.168.255.255`

#### VPN 工作原理

- IPSec 增强 VPN 安全性的标准协议
- PPTP
- L2TP 支持多个隧道
