# EIP 1559

## EIP-1559 的组成部分

EIP-1559 主要由以下几个核心部分组成：

### 1. 基础费用（Base Fee）
- 由协议动态调整的每笔交易必须支付的最低 gas 费用
- 会根据网络拥堵情况自动调整（区块使用率）
- **这部分费用会被销毁（burn）**，而不是给矿工

### 2. 优先费用（Priority Fee / Tip）
- 用户自愿支付给矿工的小费
- 用于激励矿工优先打包自己的交易
- 这部分归矿工所有

### 3. 最大费用（Max Fee）
- 用户愿意为该笔交易支付的最高 gas 价格
- 实际支付 = Base Fee + Priority Fee
- 如果 Base Fee + Priority Fee < Max Fee，多余部分退还给用户

### 4. 动态区块大小
- 目标区块 gas 限制：15M gas -- 理论上可以打包约 714 笔简单转账（15,000,000 ÷ 21,000）
- 最大区块 gas 限制：30M gas（弹性区块） -- 理论上可以打包约 1,428 笔简单转账（30,000,000 ÷ 21,000）
- 区块可以在目标值上下浮动

## EIP-1559 的本质

**本质是一种改进的 Gas 费定价机制**，具体体现在：

1. **解决费用预测问题**：通过基础费用机制，让用户更容易预测交易成本
2. **缓解网络拥堵**：通过动态调整基础费用，平滑网络使用
3. **引入通缩机制**：销毁基础费用，减少 ETH 供应量，在高使用率时甚至可能实现通缩
4. **改善用户体验**：不再需要猜测合适的 gas 价格，降低交易失败或长时间等待的概率

## JavaScript 实现示例

### 传统交易（Legacy Transaction - Type 0）

```javascript
const { ethers } = require('ethers');

async function sendLegacyTransaction() {
  // 连接到以太坊节点
  const provider = new ethers.JsonRpcProvider('https://eth-mainnet.g.alchemy.com/v2/YOUR_API_KEY');
  
  // 创建钱包
  const privateKey = 'YOUR_PRIVATE_KEY';
  const wallet = new ethers.Wallet(privateKey, provider);
  
  // 获取当前 gas 价格（需要手动设置）
  const gasPrice = await provider.getFeeData();
  
  // 构建传统交易
  const tx = {
    to: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb',
    value: ethers.parseEther('0.1'), // 发送 0.1 ETH
    gasLimit: 21000, // 简单转账的 gas 限制
    gasPrice: gasPrice.gasPrice, // 必须指定 gasPrice
    nonce: await provider.getTransactionCount(wallet.address),
    // Type 0 交易（传统交易）
  };
  
  console.log('传统交易参数:', {
    gasPrice: ethers.formatUnits(tx.gasPrice, 'gwei') + ' Gwei',
    maxCost: ethers.formatEther(tx.gasPrice * BigInt(tx.gasLimit)) + ' ETH',
  });
  
  // 发送交易
  const txResponse = await wallet.sendTransaction(tx);
  console.log('交易哈希:', txResponse.hash);
  
  // 等待确认
  const receipt = await txResponse.wait();
  console.log('交易已确认，区块号:', receipt.blockNumber);
  
  return receipt;
}
```

### EIP-1559 交易（Type 2）

```javascript
const { ethers } = require('ethers');

async function sendEIP1559Transaction() {
  // 连接到以太坊节点
  const provider = new ethers.JsonRpcProvider('https://eth-mainnet.g.alchemy.com/v2/YOUR_API_KEY');
  
  // 创建钱包
  const privateKey = 'YOUR_PRIVATE_KEY';
  const wallet = new ethers.Wallet(privateKey, provider);
  
  // 获取费用数据
  const feeData = await provider.getFeeData();
  
  // 构建 EIP-1559 交易
  const tx = {
    to: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb',
    value: ethers.parseEther('0.1'), // 发送 0.1 ETH
    gasLimit: 21000,
    
    // EIP-1559 特有字段
    maxFeePerGas: feeData.maxFeePerGas, // 愿意支付的最高费用
    maxPriorityFeePerGas: feeData.maxPriorityFeePerGas, // 给矿工的小费
    
    nonce: await provider.getTransactionCount(wallet.address),
    type: 2, // Type 2 = EIP-1559 交易
  };
  
  console.log('EIP-1559 交易参数:', {
    maxFeePerGas: ethers.formatUnits(tx.maxFeePerGas, 'gwei') + ' Gwei',
    maxPriorityFeePerGas: ethers.formatUnits(tx.maxPriorityFeePerGas, 'gwei') + ' Gwei',
    maxCost: ethers.formatEther(tx.maxFeePerGas * BigInt(tx.gasLimit)) + ' ETH',
  });
  
  // 发送交易
  const txResponse = await wallet.sendTransaction(tx);
  console.log('交易哈希:', txResponse.hash);
  
  // 等待确认
  const receipt = await txResponse.wait();
  
  // 计算实际费用
  const actualFee = receipt.gasUsed * receipt.effectiveGasPrice;
  console.log('交易已确认:', {
    blockNumber: receipt.blockNumber,
    gasUsed: receipt.gasUsed.toString(),
    effectiveGasPrice: ethers.formatUnits(receipt.effectiveGasPrice, 'gwei') + ' Gwei',
    actualFee: ethers.formatEther(actualFee) + ' ETH',
  });
  
  return receipt;
}
```

### 核心区别对比

```javascript
// 传统交易结构
const legacyTx = {
  to: '0x...',
  value: ethers.parseEther('1.0'),
  gasLimit: 21000,
  gasPrice: '50000000000', // 50 Gwei - 固定价格，要么成功要么失败
  nonce: 1,
  // 没有 type 字段，或 type: 0
};

// EIP-1559 交易结构
const eip1559Tx = {
  to: '0x...',
  value: ethers.parseEther('1.0'),
  gasLimit: 21000,
  maxFeePerGas: '100000000000', // 100 Gwei - 最高愿意支付
  maxPriorityFeePerGas: '2000000000', // 2 Gwei - 给矿工的小费
  nonce: 1,
  type: 2, // Type 2 交易
};

// 实际费用计算公式
// 传统交易：actualFee = gasUsed * gasPrice
// EIP-1559：actualFee = gasUsed * (baseFee + priorityFee)
//           其中 baseFee + priorityFee <= maxFeePerGas
```

### 手动设置费用的示例

```javascript
const { ethers } = require('ethers');

async function customEIP1559Transaction() {
  const provider = new ethers.JsonRpcProvider('YOUR_RPC_URL');
  const wallet = new ethers.Wallet('YOUR_PRIVATE_KEY', provider);
  
  // 获取最新区块的 baseFee
  const block = await provider.getBlock('latest');
  const baseFee = block.baseFeePerGas;
  
  console.log('当前 Base Fee:', ethers.formatUnits(baseFee, 'gwei'), 'Gwei');
  
  // 手动设置费用参数
  const priorityFee = ethers.parseUnits('2', 'gwei'); // 2 Gwei 小费
  const maxFee = baseFee * 2n + priorityFee; // 预留 2 倍 baseFee 的空间
  
  const tx = {
    to: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb',
    value: ethers.parseEther('0.01'),
    gasLimit: 21000,
    maxFeePerGas: maxFee,
    maxPriorityFeePerGas: priorityFee,
    type: 2,
  };
  
  console.log('自定义费用设置:', {
    baseFee: ethers.formatUnits(baseFee, 'gwei') + ' Gwei',
    priorityFee: ethers.formatUnits(priorityFee, 'gwei') + ' Gwei',
    maxFee: ethers.formatUnits(maxFee, 'gwei') + ' Gwei',
    estimatedCost: ethers.formatEther(maxFee * BigInt(21000)) + ' ETH',
  });
  
  const txResponse = await wallet.sendTransaction(tx);
  const receipt = await txResponse.wait();
  
  // 退款计算
  const actualGasPrice = receipt.effectiveGasPrice;
  const refund = (maxFee - actualGasPrice) * receipt.gasUsed;
  
  console.log('交易完成:', {
    paid: ethers.formatEther(actualGasPrice * receipt.gasUsed) + ' ETH',
    refunded: ethers.formatEther(refund) + ' ETH',
  });
  
  return receipt;
}
```

## 关键差异总结

| 特性 | 传统交易 | EIP-1559 交易 |
|------|---------|---------------|
| 交易类型 | Type 0 | Type 2 |
| Gas 定价 | `gasPrice` | `maxFeePerGas` + `maxPriorityFeePerGas` |
| 费用预测 | 困难，需要竞价 | 简单，协议自动调整 |
| 矿工收入 | 全部 gas 费 | 仅收到 priority fee |
| Base Fee | 不存在 | 存在且被销毁 |
| 退款机制 | 无 | 有（多付部分自动退还） |
| 区块大小 | 固定 | 弹性（目标 15M，最大 30M） |

## 实际应用建议

1. **普通转账**：使用默认的 `feeData` 即可
2. **紧急交易**：增加 `maxPriorityFeePerGas` 来加快打包
3. **非紧急交易**：降低 `maxPriorityFeePerGas` 以节省费用
4. **合约交互**：预估好 `gasLimit`，避免浪费
