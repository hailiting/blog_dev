# EIP-4844 (Proto-Danksharding)

## æ¦‚è¿°

**EIP-4844**ï¼Œä¹Ÿç§°ä¸º **Proto-Danksharding** æˆ– **Blob Transactions**ï¼Œæ˜¯ä»¥å¤ªåŠåœ¨ 2024 å¹´ 3 æœˆ Dencun å‡çº§ä¸­æ¿€æ´»çš„é‡è¦ææ¡ˆã€‚

### ğŸ¯ æ ¸å¿ƒç›®æ ‡
**å¤§å¹…é™ä½ Layer 2 (Rollup) çš„æ•°æ®å‘å¸ƒæˆæœ¬**ï¼Œä½¿ L2 äº¤æ˜“è´¹ç”¨é™ä½ **10-100 å€**ã€‚

### ğŸ“… å…³é”®ä¿¡æ¯
- **ææ¡ˆç¼–å·**ï¼šEIP-4844
- **æ¿€æ´»æ—¶é—´**ï¼š2024 å¹´ 3 æœˆ 13 æ—¥ï¼ˆDencun å‡çº§ï¼‰
- **åˆ«å**ï¼šProto-Dankshardingã€Blob Transactions
- **äº¤æ˜“ç±»å‹**ï¼šType 3

## EIP-4844 çš„ç»„æˆéƒ¨åˆ†

### 1. Blobï¼ˆBinary Large Objectï¼‰

**Blob** æ˜¯ä¸€ç§æ–°çš„æ•°æ®ç±»å‹ï¼Œä¸“é—¨ç”¨äºå­˜å‚¨ä¸´æ—¶çš„ã€å¤§é‡çš„æ•°æ®ã€‚

#### Blob ç‰¹æ€§ï¼š
- **å•ä¸ª Blob å¤§å°**ï¼š~128 KB (131,072 bytes)
- **æ¯åŒºå—ç›®æ ‡**ï¼š3 ä¸ª blobs
- **æ¯åŒºå—æœ€å¤§**ï¼š6 ä¸ª blobs
- **å­˜å‚¨æ—¶é•¿**ï¼šçº¦ 18 å¤©ååˆ é™¤ï¼ˆä¸æ°¸ä¹…å­˜å‚¨ï¼‰
- **æ•°æ®éªŒè¯**ï¼šä½¿ç”¨ KZG æ‰¿è¯ºï¼Œæ— éœ€ä¸‹è½½å®Œæ•´æ•°æ®

```javascript
// Blob å‚æ•°
const BLOB_SIZE = 131072;              // 128 KB
const FIELD_ELEMENTS_PER_BLOB = 4096;  // æ¯ä¸ª blob çš„å­—æ®µå…ƒç´ æ•°
const TARGET_BLOB_GAS_PER_BLOCK = 3 * BLOB_SIZE;  // 393,216
const MAX_BLOB_GAS_PER_BLOCK = 6 * BLOB_SIZE;     // 786,432
```

### 2. æ–°çš„äº¤æ˜“ç±»å‹ï¼šType 3

```
Type 0: Legacy Transactionï¼ˆä¼ ç»Ÿäº¤æ˜“ï¼‰
Type 1: EIP-2930ï¼ˆè®¿é—®åˆ—è¡¨äº¤æ˜“ï¼‰
Type 2: EIP-1559ï¼ˆåŠ¨æ€è´¹ç”¨äº¤æ˜“ï¼‰
Type 3: EIP-4844ï¼ˆBlob äº¤æ˜“ï¼‰â† æ–°å¢
```

#### Type 3 äº¤æ˜“ç»“æ„ï¼š
```javascript
const blobTransaction = {
  type: 3,
  
  // å¸¸è§„å­—æ®µï¼ˆç»§æ‰¿è‡ª Type 2ï¼‰
  to: '0x...',
  value: 0n,
  data: '0x...',
  gasLimit: 100000,
  maxFeePerGas: ethers.parseUnits('50', 'gwei'),
  maxPriorityFeePerGas: ethers.parseUnits('2', 'gwei'),
  nonce: 0,
  
  // Blob ç‰¹æœ‰å­—æ®µ
  maxFeePerBlobGas: ethers.parseUnits('10', 'gwei'), // blob gas æœ€é«˜è´¹ç”¨
  blobVersionedHashes: [
    '0x01...' // KZG æ‰¿è¯ºçš„ç‰ˆæœ¬åŒ–å“ˆå¸Œ
  ],
  blobs: [blobData], // å®é™… blob æ•°æ®ï¼ˆä»…åœ¨å‘é€æ—¶éœ€è¦ï¼‰
  commitments: [...], // KZG æ‰¿è¯º
  proofs: [...],      // KZG è¯æ˜
};
```

### 3. ç‹¬ç«‹çš„ Blob Gas å¸‚åœº

EIP-4844 å¼•å…¥äº†**ç‹¬ç«‹äºä¸» gas å¸‚åœº**çš„ blob gas å¸‚åœºï¼š

- **Blob Gas ä»·æ ¼**ï¼šç‹¬ç«‹çš„ blob base fee
- **å®šä»·æœºåˆ¶**ï¼šç±»ä¼¼ EIP-1559ï¼Œä½†ä½¿ç”¨ä¸åŒçš„è°ƒæ•´å‡½æ•°
- **ç›®æ ‡ä½¿ç”¨ç‡**ï¼šæ¯åŒºå— 3 ä¸ª blobs
- **å¼¹æ€§ç©ºé—´**ï¼šæœ€å¤š 6 ä¸ª blobs

#### Blob Base Fee è®¡ç®—å…¬å¼ï¼š

```javascript
function calculateBlobBaseFee(excessBlobGas) {
  const MIN_BLOB_BASE_FEE = 1n;
  const BLOB_BASE_FEE_UPDATE_FRACTION = 3338477n;
  
  return fakeExponential(
    MIN_BLOB_BASE_FEE,
    excessBlobGas,
    BLOB_BASE_FEE_UPDATE_FRACTION
  );
}

function fakeExponential(factor, numerator, denominator) {
  let output = 0n;
  let numeratorAccumulator = factor * denominator;
  let denominatorAccumulator = denominator;
  
  for (let i = 1n; numeratorAccumulator > 0n; i++) {
    output += numeratorAccumulator;
    numeratorAccumulator = (numeratorAccumulator * numerator) / (denominator * i);
  }
  
  return output / denominatorAccumulator;
}

// ä½¿ç”¨ç¤ºä¾‹
const excessBlobGas = 262144n; // 2 ä¸ª blob çš„è¶…é¢
const blobBaseFee = calculateBlobBaseFee(excessBlobGas);
console.log('Blob Base Fee:', ethers.formatUnits(blobBaseFee, 'gwei'), 'Gwei');
```

### 4. KZG æ‰¿è¯ºï¼ˆKZG Commitmentsï¼‰

**KZG** æ˜¯ä¸€ç§å¤šé¡¹å¼æ‰¿è¯ºæ–¹æ¡ˆï¼Œç”¨äºéªŒè¯ blob æ•°æ®çš„å®Œæ•´æ€§ã€‚

#### ä¼˜åŠ¿ï¼š
- âœ… èŠ‚ç‚¹æ— éœ€ä¸‹è½½å®Œæ•´ blob å³å¯éªŒè¯
- âœ… æ‰¿è¯ºå¤§å°å›ºå®šï¼ˆ48 å­—èŠ‚ï¼‰
- âœ… éªŒè¯é€Ÿåº¦å¿«
- âœ… æ”¯æŒæ•°æ®å¯ç”¨æ€§é‡‡æ ·ï¼ˆDASï¼‰

```javascript
// KZG ç›¸å…³å¸¸é‡
const BYTES_PER_COMMITMENT = 48;
const BYTES_PER_PROOF = 48;
const BYTES_PER_FIELD_ELEMENT = 32;

// KZG æ‰¿è¯ºç”Ÿæˆï¼ˆç®€åŒ–ç¤ºæ„ï¼‰
function generateKZGCommitment(blobData) {
  // 1. å°† blob æ•°æ®è½¬æ¢ä¸ºå¤šé¡¹å¼
  const polynomial = blobToPolynomial(blobData);
  
  // 2. ä½¿ç”¨ KZG setup çš„å…¬å…±å‚æ•°ç”Ÿæˆæ‰¿è¯º
  const commitment = kzgCommit(polynomial);
  
  // 3. ç”Ÿæˆè¯æ˜
  const proof = kzgCreateProof(polynomial);
  
  return { commitment, proof };
}

// éªŒè¯ KZG æ‰¿è¯º
function verifyKZGCommitment(commitment, proof, blobHash) {
  return kzgVerifyProof(commitment, proof, blobHash);
}
```

## EIP-4844 vs EIP-1559 å¯¹æ¯”

| ç‰¹æ€§ | EIP-1559 | EIP-4844 |
|------|----------|----------|
| **ç›®æ ‡** | ä¼˜åŒ–ä¸»ç½‘ gas è´¹ç”¨ | é™ä½ L2 æ•°æ®æˆæœ¬ |
| **æ¿€æ´»æ—¶é—´** | 2021 å¹´ 8 æœˆ | 2024 å¹´ 3 æœˆ |
| **äº¤æ˜“ç±»å‹** | Type 2 | Type 3 |
| **æ•°æ®å­˜å‚¨** | æ°¸ä¹…å­˜å‚¨åœ¨é“¾ä¸Š | ä¸´æ—¶å­˜å‚¨ï¼ˆ~18å¤©ï¼‰ |
| **è´¹ç”¨å¸‚åœº** | Gas market | ç‹¬ç«‹çš„ Blob gas market |
| **ä¸»è¦å—ç›Šè€…** | æ‰€æœ‰ä»¥å¤ªåŠç”¨æˆ· | Layer 2 ç”¨æˆ· |
| **åŒºå—æ‰©å±•** | 15M-30M gas | é¢å¤– 3-6 blobs |
| **è´¹ç”¨é”€æ¯** | Base fee é”€æ¯ | Blob base fee é”€æ¯ |
| **æ•°æ®éªŒè¯** | æ‰§è¡Œæ‰€æœ‰äº¤æ˜“ | KZG æ‰¿è¯ºéªŒè¯ |

## JavaScript å®ç°ç¤ºä¾‹

### 1. å‘é€ Blob äº¤æ˜“ï¼ˆL2 Sequencerï¼‰

```javascript
const { ethers } = require('ethers');

async function sendBlobTransaction() {
  const provider = new ethers.JsonRpcProvider('https://eth-mainnet.g.alchemy.com/v2/YOUR_API_KEY');
  const wallet = new ethers.Wallet('YOUR_PRIVATE_KEY', provider);
  
  // å‡†å¤‡ blob æ•°æ®ï¼ˆL2 æ‰¹æ¬¡äº¤æ˜“æ•°æ®ï¼‰
  const batchData = prepareBatchData(); // ä½ çš„ L2 äº¤æ˜“æ‰¹æ¬¡
  const blobData = encodeToBlobFormat(batchData); // ç¼–ç ä¸º blob æ ¼å¼
  
  // ç”Ÿæˆ KZG æ‰¿è¯º
  const { commitment, proof, versionedHash } = generateKZGCommitment(blobData);
  
  // è·å–å½“å‰è´¹ç”¨æ•°æ®
  const feeData = await provider.getFeeData();
  const block = await provider.getBlock('latest');
  
  // è®¡ç®— blob gas è´¹ç”¨
  const blobBaseFee = calculateBlobBaseFee(block.excessBlobGas || 0n);
  const maxFeePerBlobGas = blobBaseFee * 2n; // è®¾ç½®ä¸ºå½“å‰çš„ 2 å€
  
  // æ„å»º Type 3 äº¤æ˜“
  const tx = {
    to: '0xYourL2SequencerContract',
    data: encodeL2BatchSubmission(versionedHash), // åˆçº¦è°ƒç”¨æ•°æ®
    
    // æ‰§è¡Œéƒ¨åˆ†çš„ gasï¼ˆä½¿ç”¨ EIP-1559ï¼‰
    gasLimit: 200000,
    maxFeePerGas: feeData.maxFeePerGas,
    maxPriorityFeePerGas: feeData.maxPriorityFeePerGas,
    
    // Blob éƒ¨åˆ†ï¼ˆæ–°å¢ï¼‰
    type: 3,
    maxFeePerBlobGas: maxFeePerBlobGas,
    blobVersionedHashes: [versionedHash],
    blobs: [blobData],
    commitments: [commitment],
    proofs: [proof],
  };
  
  console.log('ğŸ“¤ å‘é€ Blob äº¤æ˜“');
  console.log('Blob æ•°é‡:', tx.blobs.length);
  console.log('Blob å¤§å°:', blobData.length.toLocaleString(), 'bytes');
  console.log('Max Fee Per Blob Gas:', ethers.formatUnits(maxFeePerBlobGas, 'gwei'), 'Gwei');
  
  // å‘é€äº¤æ˜“
  const txResponse = await wallet.sendTransaction(tx);
  console.log('äº¤æ˜“å“ˆå¸Œ:', txResponse.hash);
  
  // ç­‰å¾…ç¡®è®¤
  const receipt = await txResponse.wait();
  
  // è®¡ç®—å®é™…è´¹ç”¨
  const executionCost = receipt.gasUsed * receipt.effectiveGasPrice;
  const blobCost = receipt.blobGasUsed * receipt.blobGasPrice;
  const totalCost = executionCost + blobCost;
  
  console.log('\nâœ… äº¤æ˜“å·²ç¡®è®¤');
  console.log('æ‰§è¡Œè´¹ç”¨:', ethers.formatEther(executionCost), 'ETH');
  console.log('Blob è´¹ç”¨:', ethers.formatEther(blobCost), 'ETH');
  console.log('æ€»è´¹ç”¨:', ethers.formatEther(totalCost), 'ETH');
  
  return receipt;
}

// è¾…åŠ©å‡½æ•°
function prepareBatchData() {
  // å‡†å¤‡ L2 äº¤æ˜“æ‰¹æ¬¡æ•°æ®
  return new Uint8Array(100000); // ç¤ºä¾‹ï¼š100KB æ•°æ®
}

function encodeToBlobFormat(data) {
  // å°†æ•°æ®ç¼–ç ä¸º blob æ ¼å¼ï¼ˆ128KBï¼‰
  const blobData = new Uint8Array(131072);
  blobData.set(data);
  return blobData;
}

function encodeL2BatchSubmission(blobHash) {
  // ç¼–ç åˆçº¦è°ƒç”¨æ•°æ®
  const iface = new ethers.Interface([
    'function submitBatch(bytes32 blobHash)'
  ]);
  return iface.encodeFunctionData('submitBatch', [blobHash]);
}
```

### 2. æŸ¥è¯¢ Blob Gas å¸‚åœºä¿¡æ¯

```javascript
const { ethers } = require('ethers');

async function monitorBlobGasMarket() {
  const provider = new ethers.JsonRpcProvider('YOUR_RPC_URL');
  
  // è·å–æœ€æ–°åŒºå—
  const block = await provider.getBlock('latest', true);
  
  console.log('ğŸ“Š Blob Gas å¸‚åœºçŠ¶æ€');
  console.log('='.repeat(60));
  console.log('åŒºå—å·:', block.number);
  console.log('æ—¶é—´:', new Date(block.timestamp * 1000).toLocaleString());
  console.log();
  
  // Blob ä½¿ç”¨æƒ…å†µ
  if (block.blobGasUsed !== undefined) {
    const TARGET = 3 * 131072;
    const MAX = 6 * 131072;
    const used = Number(block.blobGasUsed);
    const excess = Number(block.excessBlobGas || 0n);
    
    console.log('ğŸ“¦ Blob ä½¿ç”¨æƒ…å†µ:');
    console.log('  å·²ä½¿ç”¨:', used.toLocaleString(), 'blob gas');
    console.log('  ç›®æ ‡å€¼:', TARGET.toLocaleString(), 'blob gas (3 blobs)');
    console.log('  æœ€å¤§å€¼:', MAX.toLocaleString(), 'blob gas (6 blobs)');
    console.log('  ä½¿ç”¨ç‡:', (used / TARGET * 100).toFixed(2) + '%');
    console.log('  è¶…é¢:', excess.toLocaleString(), 'blob gas');
    console.log();
    
    // è®¡ç®— blob base fee
    const blobBaseFee = calculateBlobBaseFee(BigInt(excess));
    const nextBlobBaseFee = calculateBlobBaseFee(
      BigInt(excess + Math.max(0, used - TARGET))
    );
    
    console.log('ğŸ’° Blob è´¹ç”¨:');
    console.log('  å½“å‰ Blob Base Fee:', ethers.formatUnits(blobBaseFee, 'gwei'), 'Gwei');
    console.log('  é¢„è®¡ä¸‹ä¸€åŒºå—:', ethers.formatUnits(nextBlobBaseFee, 'gwei'), 'Gwei');
    console.log('  æ™®é€š Base Fee:', ethers.formatUnits(block.baseFeePerGas, 'gwei'), 'Gwei');
    console.log();
    
    // è´¹ç”¨å¯¹æ¯”
    const ratio = Number(blobBaseFee) / Number(block.baseFeePerGas);
    console.log('ğŸ“Š è´¹ç”¨æ¯”è¾ƒ:');
    console.log('  Blob Base Fee / Base Fee:', (ratio * 100).toFixed(2) + '%');
    
    // è®¡ç®—å‘å¸ƒ 100KB æ•°æ®çš„æˆæœ¬
    const dataSize = 100000; // 100 KB
    
    // æ–¹å¼ 1: Calldata
    const calldataGas = dataSize * 16; // 16 gas per non-zero byte
    const calldataCost = BigInt(calldataGas) * block.baseFeePerGas;
    
    // æ–¹å¼ 2: Blob
    const blobsNeeded = 1; // 100KB < 128KB
    const blobGas = blobsNeeded * 131072;
    const blobCost = BigInt(blobGas) * blobBaseFee;
    
    console.log('\nğŸ’µ å‘å¸ƒ 100KB æ•°æ®æˆæœ¬:');
    console.log('  Calldata æ–¹å¼:', ethers.formatEther(calldataCost), 'ETH');
    console.log('  Blob æ–¹å¼:', ethers.formatEther(blobCost), 'ETH');
    console.log('  èŠ‚çœ:', ((1 - Number(blobCost) / Number(calldataCost)) * 100).toFixed(2) + '%');
  } else {
    console.log('âš ï¸  è¯¥åŒºå—ä¸åŒ…å« blob æ•°æ®');
  }
  
  // ç»Ÿè®¡åŒºå—ä¸­çš„ blob äº¤æ˜“
  let blobTxCount = 0;
  for (const txHash of block.transactions) {
    const tx = await provider.getTransaction(txHash);
    if (tx.type === 3) {
      blobTxCount++;
    }
  }
  
  console.log('\nğŸ“ äº¤æ˜“ç»Ÿè®¡:');
  console.log('  æ€»äº¤æ˜“æ•°:', block.transactions.length);
  console.log('  Blob äº¤æ˜“æ•°:', blobTxCount);
  console.log('  Blob äº¤æ˜“å æ¯”:', (blobTxCount / block.transactions.length * 100).toFixed(2) + '%');
}

// è¿è¡Œç›‘æ§
monitorBlobGasMarket();

// æŒç»­ç›‘æ§
setInterval(monitorBlobGasMarket, 12000); // æ¯ 12 ç§’ï¼ˆä¸€ä¸ªåŒºå—ï¼‰
```

### 3. æˆæœ¬å¯¹æ¯”åˆ†æ

```javascript
const { ethers } = require('ethers');

async function analyzeCostSavings() {
  const provider = new ethers.JsonRpcProvider('YOUR_RPC_URL');
  const block = await provider.getBlock('latest');
  
  // å‡è®¾å‚æ•°
  const ETH_PRICE_USD = 3000; // ETH ä»·æ ¼
  const dataSizes = [50000, 100000, 200000, 500000]; // ä¸åŒæ•°æ®å¤§å°
  
  console.log('ğŸ’° L2 æ•°æ®å‘å¸ƒæˆæœ¬å¯¹æ¯”åˆ†æ');
  console.log('='.repeat(80));
  console.log(`ETH ä»·æ ¼: $${ETH_PRICE_USD}`);
  console.log(`Base Fee: ${ethers.formatUnits(block.baseFeePerGas, 'gwei')} Gwei`);
  
  // è®¡ç®— blob base fee
  const blobBaseFee = calculateBlobBaseFee(block.excessBlobGas || 0n);
  console.log(`Blob Base Fee: ${ethers.formatUnits(blobBaseFee, 'gwei')} Gwei`);
  console.log();
  
  console.log('æ•°æ®å¤§å° | Calldata æˆæœ¬ | Blob æˆæœ¬ | èŠ‚çœé‡‘é¢ | èŠ‚çœæ¯”ä¾‹');
  console.log('-'.repeat(80));
  
  for (const size of dataSizes) {
    // Calldata æ–¹å¼
    const calldataGas = size * 16;
    const calldataCostWei = BigInt(calldataGas) * block.baseFeePerGas;
    const calldataCostUSD = Number(ethers.formatEther(calldataCostWei)) * ETH_PRICE_USD;
    
    // Blob æ–¹å¼
    const blobsNeeded = Math.ceil(size / 131072);
    const blobGas = blobsNeeded * 131072;
    const blobCostWei = BigInt(blobGas) * blobBaseFee;
    const blobCostUSD = Number(ethers.formatEther(blobCostWei)) * ETH_PRICE_USD;
    
    // è®¡ç®—èŠ‚çœ
    const savingsUSD = calldataCostUSD - blobCostUSD;
    const savingsPercent = (savingsUSD / calldataCostUSD * 100).toFixed(2);
    
    console.log(
      `${(size/1000).toString().padEnd(9)}KB | ` +
      `$${calldataCostUSD.toFixed(2).padEnd(13)} | ` +
      `$${blobCostUSD.toFixed(2).padEnd(9)} | ` +
      `$${savingsUSD.toFixed(2).padEnd(9)} | ` +
      `${savingsPercent}%`
    );
  }
  
  console.log();
  
  // å¹´åº¦æˆæœ¬åˆ†æ
  console.log('ğŸ“ˆ å¹´åº¦æˆæœ¬åˆ†æï¼ˆå‡è®¾æ¯å¤©å‘å¸ƒ 1000 ä¸ªæ‰¹æ¬¡ï¼Œæ¯æ‰¹æ¬¡ 100KBï¼‰');
  console.log('-'.repeat(80));
  
  const batchesPerDay = 1000;
  const daysPerYear = 365;
  const batchSize = 100000; // 100KB
  
  // Calldata æ–¹å¼å¹´åº¦æˆæœ¬
  const calldataGasPerBatch = batchSize * 16;
  const calldataCostPerBatch = BigInt(calldataGasPerBatch) * block.baseFeePerGas;
  const calldataYearlyCost = Number(ethers.formatEther(calldataCostPerBatch)) * batchesPerDay * daysPerYear * ETH_PRICE_USD;
  
  // Blob æ–¹å¼å¹´åº¦æˆæœ¬
  const blobGasPerBatch = 131072; // 1 blob
  const blobCostPerBatch = BigInt(blobGasPerBatch) * blobBaseFee;
  const blobYearlyCost = Number(ethers.formatEther(blobCostPerBatch)) * batchesPerDay * daysPerYear * ETH_PRICE_USD;
  
  console.log(`Calldata å¹´åº¦æˆæœ¬: $${calldataYearlyCost.toLocaleString()}`);
  console.log(`Blob å¹´åº¦æˆæœ¬: $${blobYearlyCost.toLocaleString()}`);
  console.log(`å¹´åº¦èŠ‚çœ: $${(calldataYearlyCost - blobYearlyCost).toLocaleString()}`);
  console.log(`èŠ‚çœæ¯”ä¾‹: ${((calldataYearlyCost - blobYearlyCost) / calldataYearlyCost * 100).toFixed(2)}%`);
}

analyzeCostSavings();
```

## å®é™…åº”ç”¨åœºæ™¯

### 1. Layer 2 Rollups

æ‰€æœ‰ä¸»æµ L2 éƒ½å·²é‡‡ç”¨ EIP-4844 æ¥é™ä½æˆæœ¬ï¼š

```javascript
// Optimism ä½¿ç”¨ Blob å‘å¸ƒæ‰¹æ¬¡
const optimismBatch = {
  sequencer: '0x...',
  batchIndex: 12345,
  transactions: [...], // L2 äº¤æ˜“åˆ—è¡¨
  stateRoot: '0x...',
  blob: encodeBatchToBlob(transactions),
};

// Arbitrum ä½¿ç”¨ Blob å‘å¸ƒæ•°æ®
const arbitrumBatch = {
  sequencerAddress: '0x...',
  dataBlob: compressAndEncodeToBlob(txData),
  batchHash: '0x...',
};

// zkSync ä½¿ç”¨ Blob å‘å¸ƒ zkProofs
const zkSyncBatch = {
  prover: '0x...',
  proof: zkProof,
  publicInputs: [...],
  blob: encodeProofToBlob(zkProof),
};
```

### 2. ä¸»æµ L2 å¯¹æ¯”

| L2 é¡¹ç›® | Blob æ”¯æŒ | å¹³å‡èŠ‚çœ | ç”¨é€” |
|---------|-----------|----------|------|
| **Optimism** | âœ… | ~95% | äº¤æ˜“æ‰¹æ¬¡æ•°æ® |
| **Arbitrum** | âœ… | ~97% | å‹ç¼©äº¤æ˜“æ•°æ® |
| **Base** | âœ… | ~95% | Coinbase L2 æ‰¹æ¬¡ |
| **zkSync Era** | âœ… | ~90% | zkProof + äº¤æ˜“ |
| **Scroll** | âœ… | ~92% | zkEVM æ•°æ® |
| **Linea** | âœ… | ~93% | ConsenSys L2 |
| **Starknet** | âœ… | ~88% | Cairo è¯æ˜ |

### 3. å®é™…è´¹ç”¨å¯¹æ¯”ï¼ˆ2024 å¹´æ•°æ®ï¼‰

```javascript
// çœŸå®æ¡ˆä¾‹ï¼šOptimism æ‰¹æ¬¡å‘å¸ƒ

// EIP-4844 ä¹‹å‰ï¼ˆä½¿ç”¨ Calldataï¼‰
const beforeEIP4844 = {
  date: '2024-02-01',
  avgBatchSize: 100000, // 100 KB
  avgGasPrice: 30, // Gwei
  calldataGas: 1600000,
  costPerBatch: '0.048 ETH',
  costUSD: '$120', // ETH = $2500
  batchesPerDay: 1000,
  dailyCost: '$120,000',
  monthlyCost: '$3,600,000',
};

// EIP-4844 ä¹‹åï¼ˆä½¿ç”¨ Blobï¼‰
const afterEIP4844 = {
  date: '2024-04-01',
  avgBatchSize: 100000, // 100 KB
  avgBlobGasPrice: 3, // Gwei
  blobGas: 131072,
  costPerBatch: '0.0004 ETH',
  costUSD: '$1.20', // ETH = $3000
  batchesPerDay: 1000,
  dailyCost: '$1,200',
  monthlyCost: '$36,000',
};

console.log('ğŸ’° Optimism æˆæœ¬èŠ‚çœ:');
console.log('æœˆåº¦èŠ‚çœ:', '$3,564,000');
console.log('èŠ‚çœæ¯”ä¾‹:', '99%');
```

## æŠ€æœ¯ç»†èŠ‚

### 1. Blob æ•°æ®æ ¼å¼

```javascript
// Blob ç»“æ„
const BLOB_TX_TYPE = 0x03;
const VERSIONED_HASH_VERSION_KZG = 0x01;
const BYTES_PER_FIELD_ELEMENT = 32;
const FIELD_ELEMENTS_PER_BLOB = 4096;
const BLOB_SIZE = BYTES_PER_FIELD_ELEMENT * FIELD_ELEMENTS_PER_BLOB; // 131072

// Blob æ•°æ®å¿…é¡»æ˜¯æœ‰æ•ˆçš„ BLS12-381 å­—æ®µå…ƒç´ 
function validateBlobData(blobData) {
  if (blobData.length !== BLOB_SIZE) {
    throw new Error('Invalid blob size');
  }
  
  // æ¯ä¸ª 32 å­—èŠ‚å­—æ®µå…ƒç´ å¿…é¡» < BLS_MODULUS
  const BLS_MODULUS = BigInt('52435875175126190479447740508185965837690552500527637822603658699938581184513');
  
  for (let i = 0; i < FIELD_ELEMENTS_PER_BLOB; i++) {
    const offset = i * BYTES_PER_FIELD_ELEMENT;
    const element = bytesToBigInt(blobData.slice(offset, offset + 32));
    
    if (element >= BLS_MODULUS) {
      throw new Error(`Invalid field element at index ${i}`);
    }
  }
  
  return true;
}
```

### 2. ç‰ˆæœ¬åŒ–å“ˆå¸Œ

```javascript
// ç”Ÿæˆç‰ˆæœ¬åŒ–å“ˆå¸Œ
function computeVersionedHash(commitment) {
  const hash = sha256(commitment);
  hash[0] = VERSIONED_HASH_VERSION_KZG;
  return hash;
}

// ç¤ºä¾‹
const commitment = new Uint8Array(48); // KZG æ‰¿è¯º
const versionedHash = computeVersionedHash(commitment);
console.log('Versioned Hash:', ethers.hexlify(versionedHash));
// è¾“å‡º: 0x01a7b3c4d5e6f7... (ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯ 0x01)
```

### 3. Gas è®¡ç®—

```javascript
// Type 3 äº¤æ˜“çš„æ€» gas æˆæœ¬

// 1. æ‰§è¡Œ gasï¼ˆå¸¸è§„éƒ¨åˆ†ï¼‰
const executionGas = 21000 + calldataGas + executionGas;
const executionCost = executionGas * (baseFee + priorityFee);

// 2. Blob gasï¼ˆç‹¬ç«‹è®¡è´¹ï¼‰
const blobGas = blobCount * 131072;
const blobCost = blobGas * blobBaseFee;

// 3. æ€»æˆæœ¬
const totalCost = executionCost + blobCost;

console.log('æ‰§è¡Œæˆæœ¬:', ethers.formatEther(executionCost), 'ETH');
console.log('Blob æˆæœ¬:', ethers.formatEther(blobCost), 'ETH');
console.log('æ€»æˆæœ¬:', ethers.formatEther(totalCost), 'ETH');
```

### 4. æ•°æ®å¯ç”¨æ€§ä¿è¯

```javascript
// Blob æ•°æ®è™½ç„¶åªä¿å­˜ 18 å¤©ï¼Œä½†æœ‰å¤šé‡ä¿è¯æœºåˆ¶

// 1. L2 èŠ‚ç‚¹ä¿å­˜å®Œæ•´æ•°æ®
// 2. ä»¥å¤ªåŠå½’æ¡£èŠ‚ç‚¹å¯é€‰æ‹©ä¿å­˜
// 3. ç¬¬ä¸‰æ–¹æ•°æ®å¯ç”¨æ€§æœåŠ¡ï¼ˆå¦‚ EigenDAï¼‰
// 4. KZG æ‰¿è¯ºæ°¸ä¹…ä¿å­˜åœ¨é“¾ä¸Šï¼Œå¯éªŒè¯æ•°æ®

// æ•°æ®å¯ç”¨æ€§æ£€æŸ¥
async function checkBlobDataAvailability(blobHash, blockNumber) {
  const currentBlock = await provider.getBlockNumber();
  const blockAge = currentBlock - blockNumber;
  const daysOld = (blockAge * 12) / 86400; // 12ç§’ä¸€ä¸ªåŒºå—
  
  if (daysOld > 18) {
    console.log('âš ï¸  Blob æ•°æ®å¯èƒ½å·²è¿‡æœŸï¼ˆè¶…è¿‡ 18 å¤©ï¼‰');
    console.log('å»ºè®®ä» L2 å½’æ¡£èŠ‚ç‚¹æˆ– DA æœåŠ¡è·å–');
  } else {
    console.log('âœ… Blob æ•°æ®åº”è¯¥ä»åœ¨ä»¥å¤ªåŠç½‘ç»œä¸­');
  }
  
  return daysOld <= 18;
}
```

## ä¸ Full Danksharding çš„å…³ç³»

EIP-4844 æ˜¯ **Proto-Danksharding**ï¼ˆå‰ç½®ç‰ˆæœ¬ï¼‰ï¼Œä¸ºæœªæ¥çš„ **Full Danksharding** é“ºè·¯ã€‚

### åŒºåˆ«å¯¹æ¯”ï¼š

| ç‰¹æ€§ | Proto-Danksharding (EIP-4844) | Full Danksharding (æœªæ¥) |
|------|-------------------------------|-------------------------|
| **Blob æ•°é‡** | 3-6 ä¸ª/åŒºå— | 64+ ä¸ª/åŒºå— |
| **æ•°æ®é‡‡æ ·** | ä¸æ”¯æŒ | æ”¯æŒ DAS |
| **éªŒè¯æ–¹å¼** | å…¨èŠ‚ç‚¹ä¸‹è½½æ‰€æœ‰ blob | è½»èŠ‚ç‚¹éšæœºé‡‡æ · |
| **ååé‡** | ~0.375 MB/s | ~16 MB/s |
| **æ¿€æ´»æ—¶é—´** | 2024 å¹´ | 2025-2026 å¹´ï¼ˆé¢„è®¡ï¼‰ |

### å‡çº§è·¯å¾„ï¼š

```
2021-08: EIP-1559 (ä¼˜åŒ– gas è´¹ç”¨)
         â†“
2024-03: EIP-4844 (é™ä½ L2 æˆæœ¬ 10-100 å€)
         â†“
2025-26: Full Danksharding (å†é™ä½ 10-100 å€)
         â†“
æœªæ¥:    å®Œå…¨åˆ†ç‰‡ç³»ç»Ÿ
```

## æœ€ä½³å®è·µ

### 1. L2 Sequencer å»ºè®®

```javascript
// æ‰¹æ¬¡æ‰“åŒ…ç­–ç•¥
async function optimizeBatchPacking(transactions) {
  const MAX_BLOB_SIZE = 131072;
  const TARGET_BLOBS_PER_BLOCK = 3;
  
  // 1. å‹ç¼©äº¤æ˜“æ•°æ®
  const compressedData = compressTransactions(transactions);
  
  // 2. åˆ†æ‰¹
  const batches = [];
  for (let i = 0; i < compressedData.length; i += MAX_BLOB_SIZE) {
    batches.push(compressedData.slice(i, i + MAX_BLOB_SIZE));
  }
  
  // 3. ä¼˜åŒ–å‘é€æ—¶æœº
  const blobBaseFee = await getCurrentBlobBaseFee();
  if (blobBaseFee < TARGET_BLOB_BASE_FEE) {
    // è´¹ç”¨ä½ï¼Œç«‹å³å‘é€
    await sendBlobBatches(batches);
  } else {
    // è´¹ç”¨é«˜ï¼Œç­‰å¾…æˆ–ä½¿ç”¨å¤šä¸ªå°æ‰¹æ¬¡
    await waitForLowerFee();
  }
}
```

### 2. è´¹ç”¨ä¼°ç®—

```javascript
async function estimateBlobTransactionCost(dataSize) {
  const provider = new ethers.JsonRpcProvider('YOUR_RPC_URL');
  const block = await provider.getBlock('latest');
  
  // è®¡ç®—éœ€è¦çš„ blob æ•°é‡
  const blobsNeeded = Math.ceil(dataSize / 131072);
  
  // æ‰§è¡Œ gas
  const executionGas = 200000; // åˆçº¦è°ƒç”¨
  const executionCost = BigInt(executionGas) * block.baseFeePerGas;
  
  // Blob gas
  const blobGas = blobsNeeded * 131072;
  const blobBaseFee = calculateBlobBaseFee(block.excessBlobGas || 0n);
  const blobCost = BigInt(blobGas) * blobBaseFee;
  
  // æ€»æˆæœ¬
  const totalCost = executionCost + blobCost;
  
  return {
    blobsNeeded,
    executionCost: ethers.formatEther(executionCost),
    blobCost: ethers.formatEther(blobCost),
    totalCost: ethers.formatEther(totalCost),
    breakdown: {
      execution: (Number(executionCost) / Number(totalCost) * 100).toFixed(2) + '%',
      blob: (Number(blobCost) / Number(totalCost) * 100).toFixed(2) + '%',
    }
  };
}

// ä½¿ç”¨
const estimate = await estimateBlobTransactionCost(100000);
console.log('é¢„ä¼°æˆæœ¬:', estimate);
```

### 3. ç›‘æ§å’Œå‘Šè­¦

```javascript
// ç›‘æ§ blob gas å¸‚åœº
async function setupBlobGasMonitoring() {
  const ALERT_THRESHOLD = ethers.parseUnits('50', 'gwei');
  
  setInterval(async () => {
    const block = await provider.getBlock('latest');
    const blobBaseFee = calculateBlobBaseFee(block.excessBlobGas || 0n);
    
    if (blobBaseFee > ALERT_THRESHOLD) {
      console.log('ğŸš¨ è­¦å‘Š: Blob gas è´¹ç”¨è¿‡é«˜!');
      console.log('å½“å‰:', ethers.formatUnits(blobBaseFee, 'gwei'), 'Gwei');
      // å‘é€å‘Šè­¦...
    }
    
    // è®°å½•æŒ‡æ ‡
    logMetric('blob_base_fee', Number(blobBaseFee));
    logMetric('blob_usage', Number(block.blobGasUsed || 0n));
  }, 12000); // æ¯ä¸ªåŒºå—
}
```

## å‚è€ƒèµ„æº

- **å®˜æ–¹è§„èŒƒ**: [EIP-4844](https://eips.ethereum.org/EIPS/eip-4844)
- **KZG ä»ªå¼**: [ceremony.ethereum.org](https://ceremony.ethereum.org/)
- **Blob æµè§ˆå™¨**: [blobscan.com](https://blobscan.com/)
- **è´¹ç”¨è¿½è¸ª**: [ultrasound.money](https://ultrasound.money/)
- **L2 æ•°æ®**: [l2beat.com](https://l2beat.com/)

## æ€»ç»“

EIP-4844 é€šè¿‡å¼•å…¥ **Blob** è¿™ç§ä¸´æ—¶æ•°æ®å­˜å‚¨æ–¹å¼ï¼ŒæˆåŠŸå°† Layer 2 çš„æ•°æ®å‘å¸ƒæˆæœ¬é™ä½äº† **10-100 å€**ï¼Œæ˜¯ä»¥å¤ªåŠæ‰©å®¹è·¯çº¿å›¾ä¸Šçš„é‡è¦é‡Œç¨‹ç¢‘ã€‚

### å…³é”®è¦ç‚¹ï¼š
- âœ… Blob å¤§å°ï¼š128 KB
- âœ… æ¯åŒºå— 3-6 ä¸ª blobs
- âœ… ç‹¬ç«‹çš„ blob gas å¸‚åœº
- âœ… æ•°æ®ä¿å­˜ ~18 å¤©
- âœ… ä½¿ç”¨ KZG æ‰¿è¯ºéªŒè¯
- âœ… æ‰€æœ‰ä¸»æµ L2 å·²é‡‡ç”¨

