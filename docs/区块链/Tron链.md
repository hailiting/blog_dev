# Tron 链 - 波场

## 共识机制

- DPos 持有 TRX 代币的持有人选择代表验证交易和生成新的区块

## Tron 资源模型

- 投票权 TP
  - 用途: 给超级代表投票
  - 获取方式: 质押 TRX, 1TRX 获得 1TP, 质押还可获得能量或宽带
  - 可分批质押，投票权累积到账户，可通过 wallet/getaccountresource 接口查询账户拥有的总数及已使用数
- 宽带 Bandwidth Points
  - 交易以字节数方式传输于网络，交易消耗 Bandwidth Points 等于字节数，宽带不足时消耗 TRX, 燃烧的 `TRX = 消耗带宽数量 * 带宽单价 (1000sun)`
  - 宽带的获取
    - 外部账户每天 1500 免费宽带
    - 质押 TRX 获取更多，`质押获取的宽带数量 = 为获取宽带的TRX质押量 / 全网为获取宽带质押TRX的总量*43_200_000_000`
  - 带宽的消耗
    - 除查询操作，其他交易都需宽带
    - 优先消耗质押 TRX、其次消耗免费 TRX、最后燃烧 TRX
  - 宽带的恢复
    - 免费宽带和质押获取的宽带会在 24h 逐步恢复
  - 宽带余额查询
    - 调用节点 HTTP 接口`wallet/getaccountresource` 来获取
    - 计算方法: `免费宽带余额 = freeNetLimit - freeNetUsed`; `通过质押获取的宽带余额 = NetLimit - NetUsed`
- 能量
  - 执行指令消耗能量，不同复杂度合约消耗能量不同
  - 逐步指令计算能量，能量不足扣除 TRX, 燃烧的`TRX = Energy数量 * Energy单价(420sun)`
  - 能量的获取
    - 质押 TRX 获取，`获得的能量数量 = 为获取能量质押的TRX数量/全网为获取能量质押TRX的总量*90_000_000_000(不固定)`
    - 发送 FreezeBalanceContract 类型交易来质押 TRX 获取能量
  - 能量消耗
    - 逐条指令计算并扣除
    - 优先消耗质押 TRX 获取能量，再消耗 TRX, `0.00042TRX/能量`
    - 抛出 revert 异常退出，扣除已执行指令所对应的能量
    - 异常合约(执行超时、bug)，扣除本次交易最大可用的能量
  - 能量的恢复
    - 消耗后，在 24h 逐步恢复
  - 能量余额查询
    - 调用节点 HTTP 接口`wallet/getaccountresource`来获取
    - `能量余额 = EnergyLimit - EnergyUsed`
  - 动态能量模型
    - 资源平衡机制，根据合约资源占用情况动态调整能量消耗量，使能量资源分配更合理
    - 能量放大系数 energy_factor
    - `合约交易能量消耗量 = 合约调用交易产生的基础能量消耗 * (1 + energy_factor)`

## Tron 的交易

- 定义: 来自账户私钥签名后的指令
  - 交易需广播到整个网络
  - 超级节点收到交易后执行交易，打包进区块，广播到其他节点
  - 只有被超级节点打包进区块后，并被确认，交易才被确认
- 格式：

```json
{
  "raw_data": {
    "contract": [{...}],  // 交易的主体内容
    "ref_block_bytes": "c123",  // 交易引用块的高度
    "ref_block_hash": "c3121xxx", // 交易引用块的hash
    "expiration": 12121, // 交易过期时间，超过这个时间，交易将不再被打包
    "data": "dd2", // 交易备注
    "timestamp": 1212, //
    "fee_limit": 100000 // 执行智能合约交易所允许消耗的最大能量费用
  },
  "signature": ["xxxx"]
}
```

- 交易类型
  - TRX 转账交易、TRC20 转账交易、创建智能合约交易、触发智能合约交易、质押 TRX 交易等
  - 通过调用不同的 API 接口来创建不同的交易类型
- 交易的生命周期
  - 创建交易
  ```js
  const unsignedTxn = await tronWeb.transactionBuilder.sendTrx(
    "receiveAddress",
    100,
    "sendAddress"
  );
  ```
  - 签名交易
    - 计算交易 hash
    - 使用发送者账户的私钥对该交易 hash 进行签名
    - 将生成的签名结果添加到交易对象中
    - `const signedTxn = await tronWeb.trx.sign(unsignedTxn, privateKey);`
  - 广播交易
    - 交易发送到节点后，节点在本地执行并验证，有效交易被广播，无效被丢弃
    - `const receipt = await tronWeb.trx.sendRawTransaction(signedTxn);`
  - 确认交易
    - 确认机制：某个区块产出后，19 个不同的产块节点基于这个区块产出了后续区块
    - java-tron 提供了`/walletsolidty/*` 接口
    - 不同交易确认方法不同
      - 系统合约交易: 创建智能合约类型和触发智能合约类型以外的所有类型交易，通过`/walletsolidity/gettransactioninfobyid`或`/walletsolidity/gettransactionbyidAPI`能够查询到交易，即为确认
    - 智能合约交易：创建智能合约和触发智能合约交易，通过`/walletsolidity/gettransactioninfobyid`API 查询到返回值中`receipt.result`等于`success`,或通过`/walletsolidity/gettransactionbyidAPI`查询到返回值中`transaction.ret.contractRet`是`success`来确认是否交易成功
    - 内部交易，合约中向其他普通地址或合约地址转账的交易，也是通过相关 api 查询

## Tron 区块

- 定义：包含一系列交易的集合，以及前一个区块的哈希值，形成链，难以篡改，牵一发而动全身
- 意义：确保所有节点保持一致的状态并就交易历史达成一致
- 工作原理：
  - 区块严格排序，新区块包含父区块的哈希值，任何时间，所有节点对区块的数量和历史状态达成一致
  - 超级代表产出一个区块后，广播至网络，所有节点都会将收到的区块添加到自己区块链的末尾
- 组成

```json
{
  "block_header": {
    "raw_data": {
      "number": 122,  // 区块号，即该区块处于链上的高度
      "txTrieRoot":"xxx", // 区块中交易的默克尔树的根节点的hash值
      "witness_address": "xxx", // 产出超级代表账户地址
      "parentHash": "xxx", // 上一个区块的区块ID，区块ID为区块唯一标识符，由区块高度以及区块头的raw_data的哈希值组成
      "version": 23,
      "timestamp":12321321,
    },
    "witness_signature": "xxxx" // 超级代表对该区块的签名
  },
  "transactions": [{xxx},{xxxx}] // 被打包进该区块的所有交易列表
}
```

- 间隔时间: 3s 产出一个
- 大小: 有限制，最大不超过 2,000,000bytes(约 1.9M)

## Tron 虚拟机 TVM

- 定义: TRON 网络智能合约的运行时环境，每个节点维护一个 TVM 实体
- 网络协议保证连续性、不可被打断性和操作不可逆性，TVM 定义从一个区块到另一个区块状态改变的特定规则
- TRON: 分布式状态，网络状态包含所有账户信息，而且还包含机器状态，可根据规则改变状态
- 状态转换函数
  - `Y(S,T)=S'`，旧有效状态(S),一组新的有效交易(T),新的有效输出状态`S'`
  - 存储方式，"默克尔树"，存储所有账号信息，区块存放根节点 hash
- TVM 指令
  - TVM: 基于堆栈的虚拟机
  - 编译后包含大量操作码: XOR、AND、ADD、SUB 等
  - 流程：
    - 编译器将智能合约编译为字节码
    - TVM 根据字节码处理数据
    - TVM 访问区块链数据并通过互操作层调用外部状态数据接口
    - TVM 执行结束后，状态写入区块，用户可以通过 API 查询执行结果和状态
- 用 enery 代替 gas
- TVM 兼容 EVM

## Tron 节点和客户端

- 定义: Tron 网络中运行了可以验证区块的交易数据软件的计算机
- 系统中，安装了一个客户端才叫节点，目前 Tron 客户端使用 Java 实现
- 节点类型：
  - 全节点，超级代表需运行一个全节点
  - 轻节点

## Tron 多重签名

- 多重签名功能允许权限分级，每个权限都可以对应多个私钥，使得可以实现账户的多人联合控制
- 三种权限
  - Owner: 执行所有合约
    - 最高权限，控制用户的所有权调整权限结构，执行所有合约
  - Witness: 用于超级代表出块
    - 超级代表可使用，管理出块节点
  - Active: 自定义
    - 提供一个权限组合，如 创建账户、转账功能等
- 费用
  - 更新账户权限：100TRX
  - 多重签名时，除交易费用，另收取 1TRX

## Tron 共识 => DPOS

- DPOS
  - 区块链系统启动运行时，发行通证，分给区块链节点
  - 节点凭借部分通证申请成为记账人候选人
  - 持有通证的节点投票
  - 每隔一段时间统计得票，前 N 个节点成为下一个时间内的记账人
  - 以此类推，循环往复
- Tron 实现
  - TRX 通证
  - 记账人： SR(Super Node) 27 个 也叫 witness
  - 记账顺序: 即出块顺序，27 个记账人得票多少降序
  - 区块时间: 3s
  - 槽位: 每一个区块生产出来放到一个槽位，生产一个区块填满一个 slot,未生产对应的 slot 为空
  - 出块轮：每 6h 一个，每个出块轮最后 2 个出块时间是一个维护期
  - 维护期：6s，统计投票，不进行区块生产，确定下个出块轮的出块顺序
- 保证安全稳定

  - 固化快原则
    - 产生出来的区块处于未确认状态，只有被 70%以上的 witness 认可的区块才被认为是不可逆区块（固化快）
  - 最长链原则
    - 总是选择在当前最长的那个分叉链上继续生产区块

- DPOS 和 POS
  - DPOS(委托权益证明)和 POS(权益证明) 主要区别在于节点参与验证和生成区块的方式
  - POS 允许代币持有者直接参与验证过程，拥有更多代币的参与者有更高概率被选中创建下一个区块，从而获得相应的奖励
  - DPOS: 改进了 POS，引入了代理投票的概念，所有代币持有者都可以将他们的权益委托给代表，这些代表就是所谓的"超级节点"，负责生成新的区块（可能导致更大的权力集中）
