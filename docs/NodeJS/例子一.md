# node 实战
node环境
1, 筛选需要的信息  Node 中间层服务
2, SSR
3, proxy   BFF(backend for frontend)
## 要求
~~~
1，使用PHP+MYSQL完成点赞接口，实现用户点击一次更新数据库点赞总数+1
2，使用KOA2+ES6封装PHP点赞接口，并建立路由
3，将原项目迁移进KOA2，并顺利通过index/index路由进行访问
4，将用户点击事件通过Axios链接到KOA2点赞接口
5，对用户连续点击事件进行稀释
6，完成点赞功能接口的自动化测试，点赞+1功能的自动化测试，真实页面点击自动化测试
~~~
### 项目结构
~~~
| config 配置文件夹
| public 公共资源文件夹 【 img | css | font | js 】
| rest 接口文件夹  
|         | controllers    |
|         |        | backend
|         |        | frontemd
|         |        | config
|         |        | backend.export.js
|         |        | frontend.export.js
|         | middlewares     |
|         |       | filter.js  用于捕获内部错误并输出日志信息
|         |       | response.js  统一响应请求中间件
|         | models  数据库模型 |
|         | routes    |
|         |    | backend.js
|         |    | frontend.js
|         | utils     |
|         | index.js  统一入口，导出前端和管理后台的router
| views 后台的页面
~~~

#### 项目环境搭建流程
* 1，建立koa2 && bable 环境
* 2，建立路由分发 【index/index】
* 3，模板 koa-swig
* 4，获取静态资源
* 5，配置全局环境配置
~~~
"dependencies": {
  "co": "^4.6.0",
  "koa": "^2.12.0",
  "koa-simple-router": "^0.2.0", // router
  "koa-static": "^5.0.0", // css
  "koa-swig": "^2.2.1", // render
  "path": "^0.12.7"
},
~~~




~~~
const parse = require("co-body");
const mongoose = require("mongoose");
const Post = mongoose.model("Post");
exports.create = function *(){   // * 表示这是一个gentator函数
  let post = new Post(this.req.body.post);
  let tags;
  post.set("user_id", this.user.id);
  if(yield post save()){       // yield直接获取一步执行的结果
    this.redirect("/admin/posts");  
  } else {
    tags = yield Tag.findAll();
    this.body = yield render("post/new", {post: post.toJSON(), tags: tags.toJSON()});
  }
}
~~~

controller 【用户处理的路径】  
  -> action
  -> request
  -> reponse
  -> next | - 中间件 【错误处理、配置、报告、用户信息、客户端判断端的来原、地理定位 通过next挂载到req对象群局可用】

* 抽象接口层，通过继承实现对应的方法
* 可容错可重试http请求模块
* 完善工具类文件夹
* controller把所有路都打通
* Model 集成 铺路
* 前端工程化搭载动态文件MAP分析压缩打包并至CDN
* 单侧、压测等性能分析工具发现Bug
* 编写nginx-conf 负载均衡和反向代理
* pm2 上线
## 服务器集群
负载均衡服务器 Nginx Lvs  =》 PM2 -> varnish 缓存 -> Java -> DB -> write/read -> Back【融灾】
                             |   -> stupid 缓存
                            cdn    <-
                       =》 PM2
          nagios 节点监控
## 从输入url到页面响应，发生了什么

### 经典代码
~~~
// router容错
router.get(/^\/(\d+)_(\d+)/, cModel.A,cModel.B,cModel.C);
// 
var shaObj = new jsSHA(string, 'TEXT');
var hash = shaObject.getHash("SHA_1","HEX");
//
var forPound = req.header['x-forwarded-for-pound'];
//
callback(new Error("Fail to parse http response to json, url:"+reqOptions.url+"), res, body)
//
require("./middleware")(app);
~~~