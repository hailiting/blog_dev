# ç½‘é¡µæ¸²æŸ“è¿‡ç¨‹ä¸é‡ç»˜é‡æ’
## å›¾ç‰‡
![performance_Range](./img/performance_Range.png)
1. Loading: åŠ è½½é˜¶æ®µï¼Œç½‘ç»œé€šä¿¡å’Œhtmlè§£æ
2. Scripting: Javascriptæ‰§è¡Œ
3. Rendering: é‡æ’é˜¶æ®µï¼Œæ ·å¼è®¡ç®—å’Œå¸ƒå±€css
4. Painting: é‡ç»˜é˜¶æ®µ
5. Other: å…¶ä»–äº‹ä»¶èŠ±è´¹æ—¶é—´
6. Idle: ç©ºé—²æ—¶é—´

## å¦‚ä½•å‡å°‘æˆ–é¿å…ç½‘é¡µé‡ç»˜å’Œé‡æ’
### æµè§ˆå™¨å¦‚ä½•æ¸²æŸ“ç½‘é¡µ
#### ä»€ä¹ˆæ˜¯å…³é”®æ¸²æŸ“è·¯å¾„
æ˜¯æŒ‡æµè§ˆå™¨ä»æœ€åˆæ¥æ”¶è¯·æ±‚æ¥çš„HTML, CSS, Javascriptç­‰èµ„æºï¼Œç„¶åè§£æã€æ„å»ºæ ‘ã€æ¸²æŸ“å¸ƒå±€ã€ç»˜åˆ¶ï¼Œæœ€åå‘ˆç°ç»™ç”¨æˆ·èƒ½çœ‹åˆ°çš„ç•Œé¢è¿™æ•´ä¸ªè¿‡ç¨‹ã€‚
ç”¨æˆ·çœ‹åˆ°é¡µé¢å®é™…ä¸Šæ˜¯åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼šé¡µé¢å†…å®¹åŠ è½½å®Œæˆå’Œé¡µé¢èµ„æºåŠ è½½å®Œæˆ
- é¡µé¢å†…å®¹åŠ è½½å®Œæˆ -ã€‹DOMContentLoaded
  -> ä»…å½“DOMåŠ è½½å®Œæˆï¼Œä¸åŒ…æ‹¬æ ·å¼è¡¨ã€å›¾ç‰‡ç­‰
- é¡µé¢èµ„æºåŠ è½½å®Œæˆ =ã€‹Load
  -> é¡µé¢æ‰€æœ‰DOMæ ·å¼è¡¨ã€è„šæœ¬ã€å›¾ç‰‡éƒ½åŠ è½½å®Œæˆ
#### æµè§ˆå™¨æ¸²æŸ“çš„ä¸»è¦è¿‡ç¨‹
- 1. æµè§ˆå™¨å°†è·å–çš„HTMLæ–‡æ¡£è§£æDOMæ ‘ï¼›
- 2. å¤„ç†CSSæ ‡è®°ï¼Œæ„æˆå±‚å æ ·å¼è¡¨æ¨¡å‹CSSOM(CSS Object Model);
- 3. å°†DOMå’ŒCSSOMåˆå¹¶ä¸ºæ¸²æŸ“æ ‘(Rendering Tree)ï¼Œä»£è¡¨ä¸€ç³»åˆ—å°†è¢«æ¸²æŸ“çš„å¯¹è±¡ï¼›
- 4. æ¸²æŸ“æ ‘çš„æ¯ä¸ªå…ƒç´ åŒ…å«çš„å†…å®¹éƒ½æ˜¯è®¡ç®—è¿‡çš„ï¼Œè¢«ç§°ä¸ºå¸ƒå±€``layout``ã€‚æµè§ˆå™¨ä½¿ç”¨ä¸€ç§æµå¼å¤„ç†çš„æ–¹æ³•ï¼Œåªéœ€ä¸€æ¬¡ç»˜åˆ¶æ“ä½œå°±å¯ä»¥å¸ƒç½®æ‰€æœ‰çš„å…ƒç´ 
- 5. å°†æ¸²æŸ“æ ‘çš„å„ä¸ªèŠ‚ç‚¹ç»˜åˆ¶åˆ°å±å¹•ä¸Šï¼Œè¿™ä¸€æ­¥å°±æ˜¯painting
~~~
                     DOM
                      â¬         å¸ƒå±€
HTML -> è§£æHTML -> ç”ŸæˆDOMæ ‘       ğŸ”¼
                      â¬          ğŸ”½
                    é™„ç€åˆæˆ  -> ç”Ÿæˆæ¸²æŸ“æ ‘ -> ç»˜åˆ¶ -> æ˜¾ç¤º
                      ğŸ”¼
CSSæ ·å¼ -> è§£æCSS ->ç”ŸæˆCSSè§„åˆ™æ ‘
~~~
### å…·ä½“æµç¨‹è¯¦è§£
> é‡æ’å¿…å®šä¼šé€ æˆé‡ç»˜
#### æ„å»ºDOMæ ‘
å½“æµè§ˆå™¨æ¥æ”¶åˆ°æœåŠ¡å™¨å“åº”æ¥çš„HTMLæ–‡æ¡£åï¼Œä¼šéå†æ–‡æ¡£èŠ‚ç‚¹ï¼Œç”ŸæˆDOMæ ‘ã€‚
* DOMæ ‘åœ¨æ„å»ºçš„è¿‡ç¨‹ä¸­å¯èƒ½ä¼šè¢«csså’ŒJSçš„åŠ è½½è€Œæ‰§è¡Œé˜»å¡
* ``display: none``çš„å…ƒç´ ä¹Ÿä¼šåœ¨DOMæ ‘ä¸­
* æ³¨é‡Šä¹Ÿä¼šåœ¨DOMæ•°ä¸­
* ``Script``æ ‡ç­¾ä¼šåœ¨DOMæ ‘ä¸­                    
æ— è®ºæ˜¯DOMå’ŒCSSOMï¼Œéƒ½æ˜¯è¦ç»è¿‡                
``Bytes`` ->  xxxx            
``characters``->   ``<html><head></head><body></body></html>``              
``tokens`` -> ``StartTag: html``  ``StartTag: head`` ... ``EndTag: head`` ``StartTag: body``  ``EndTag: body``                   
``nodes`` -> html head meta body  p                   
``DOM`` -> 
~~~
              html
    head                    body
 meta link               p   div
~~~
#### æ„å»ºCSSOMè§„åˆ™æ ‘
æµè§ˆå™¨è§£æcsså¹¶ç”ŸæˆCSSOMï¼Œæ¯ä¸ªCSSæ–‡ä»¶éƒ½è¢«åˆ†ææˆä¸€ä¸ªStyleSheetå¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½åŒ…å«CSSè§„åˆ™ã€‚CSSè§„åˆ™å¯¹è±¡åŒ…å«å¯¹åº”äºCSSè¯­æ³•çš„é€‰æ‹©å™¨å’Œå£°æ˜å¯¹è±¡ä»¥åŠå…¶å®ƒå¯¹è±¡ã€‚
* CSSè§£æå’ŒDOMè§£æåŒæ—¶è¿›è¡Œ
* CSSè§£æä¸``Script``çš„æ‰§è¡Œäº’æ–¥
* åœ¨``Webkit``å†…æ ¸ä¸­è¿›è¡Œäº†``script``æ‰§è¡Œä¼˜åŒ–ï¼Œåªæœ‰åœ¨JSè®¿é—®CSSæ—¶æ‰ä¼šå‘ç”Ÿäº’æ–¥
#### æ„å»ºæ¸²æŸ“æ ‘ Render Tree
é€šè¿‡DOMæ ‘å’ŒCSSè§„åˆ™æ ‘ï¼Œæµè§ˆå™¨å¯ä»¥é€šè¿‡è¿™ä¸¤ä¸ªæ„å»ºæ¸²æŸ“æ ‘ã€‚æµè§ˆå™¨ä¼šå…ˆä»DOMæ ‘çš„æ ¹èŠ‚ç‚¹æ¥éå†æ¯ä¸ªå¯è§èŠ‚ç‚¹ï¼Œç„¶åå¯¹æ¯ä¸ªå¯è§èŠ‚ç‚¹æ‰¾åˆ°é€‚é…çš„CSSæ ·å¼è§„åˆ™å¹¶åº”ç”¨ã€‚
* ``Render Tree``å’Œ``DOM Tree``ä¸å®Œå…¨å¯¹åº”
* ``display: none``çš„å…ƒç´ ä¸åœ¨``Render tree``ä¸­
* ``visibility: hidden``çš„å…ƒç´ åœ¨``Render tree``                     
æ¸²æŸ“æ ‘ç”Ÿæˆåï¼Œè¿˜æ˜¯æ²¡æœ‰åŠæ³•æ¸²æŸ“åˆ°å±å¹•ä¸Šï¼Œæ¸²æŸ“åˆ°å±å¹•éœ€è¦å¾—åˆ°å„ä¸ªèŠ‚ç‚¹ä½ç½®ä¿¡æ¯ï¼Œè¿™å°±æ˜¯éœ€è¦å¸ƒå±€(Layout)å¤„ç†äº†ã€‚
#### æ¸²æŸ“æ ‘å¸ƒå±€ Layout of the render tree
å¸ƒå±€é˜¶æ®µä»æ¸²æŸ“æ ‘æ ¹èŠ‚ç‚¹å¼€å§‹éå†ï¼Œæ¸²æŸ“æ ‘çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ª``Render Object``å¯¹è±¡ï¼ŒåŒ…å«å®½é«˜ã€ä½ç½®ã€èƒŒæ™¯è‰²ç­‰æ ·å¼ä¿¡æ¯ã€‚æ‰€ä»¥æµè§ˆå™¨å°±å¯ä»¥é€šè¿‡è¿™äº›æ ·å¼ä¿¡æ¯æ¥ç¡®å®šæ¯ä¸ªèŠ‚ç‚¹å¯¹è±¡åœ¨é¡µé¢ä¸Šçš„ç¡®åˆ‡å¤§å°å’Œä½ç½®ï¼Œå¸ƒå±€é˜¶æ®µçš„è¾“å‡ºå°±æ˜¯ç›’å­æ¨¡å‹ã€‚
* floatå…ƒç´ ï¼Œabsoulteå…ƒç´ ï¼Œfixedå…ƒç´ ä¼šå‘é€ä½ç½®åç§»
* è„±ç¦»æ–‡æ¡£æµ = è„±ç¦»``RenderTree``
#### æ¸²æŸ“æ ‘ç»˜åˆ¶ Painting the render tree
åœ¨ç»˜åˆ¶é˜¶æ®µï¼Œæµè§ˆå™¨ä¼šéå†æ¸²æŸ“æ ‘ï¼Œè°ƒç”¨æ¸²æŸ“å™¨``paint()``æ–¹æ³•ï¼Œåœ¨å±å¹•ä¸Šæ˜¾ç¤ºå†…å®¹ã€‚æ¸²æŸ“æ ‘çš„ç»˜åˆ¶å·¥å…·æ˜¯ç”±æµè§ˆå™¨çš„UIåç«¯ç»„ä»¶å®Œæˆã€‚
### æµè§ˆå™¨æ¸²æŸ“ç½‘é¡µçš„é‚£äº›äº‹
#### æµè§ˆå™¨ä¸»è¦ç»„ä»¶ç»“æ„
~~~
ç”¨æˆ·ç•Œé¢ï¼ˆç”¨æˆ·èƒ½çœ‹åˆ°çš„æµè§ˆå™¨ç•Œé¢ï¼‰
      ğŸ”½
æµè§ˆå™¨å¼•æ“ï¼ˆæŸ¥è¯¢å’Œæ“ä½œæ¸²æŸ“å¼•æ“ï¼‰       -> æ•°æ®å­˜å‚¨
      ğŸ”½
æ¸²æŸ“å¼•æ“ï¼ˆè´Ÿè´£è§£æã€æ¸²æŸ“è¯·æ±‚çš„å†…å®¹ï¼‰ ä¸»æµæ¸²æŸ“å¼•æ“ï¼š Webkit Gecko
 ğŸ”½      ğŸ”½                        ğŸ”½
ç½‘ç»œ  jsè§£æå™¨[è´Ÿè´£è§£ææ‰§è¡Œjs]   UIåç«¯[è´Ÿè´£ç»˜åˆ¶]
~~~
#### æ¸²æŸ“é˜»å¡
JSé˜»å¡é¡µé¢ï¼šJSå¯ä»¥æ“ä½œDOMæ¥ä¿®æ”¹DOMç»“æ„ï¼Œæ¯æ¬¡å»æ‰§è¡ŒJavaScriptè„šæœ¬éƒ½ä¼šä¸¥é‡é˜»å¡DOMæ ‘çš„æ„å»ºï¼Œå¦‚æœJavaScriptè„šæœ¬è¿˜æ“ä½œäº†CSSOMï¼Œè€Œæ­£å¥½è¿™ä¸ªCSSOMè¿˜æ²¡ä¸‹è½½å’Œæ„å»ºï¼Œæµè§ˆå™¨ä¼šå»¶è¿Ÿè„šæœ¬æ‰§è¡Œå’Œæ„å»ºDOM,ç›´è‡³å®Œæˆå…¶CSSOMçš„ä¸‹è½½å’Œæ„å»ºï¼Œå¦‚æœé˜»å¡äº†æ„å»ºDOMæ ‘ï¼Œä¹Ÿé˜»å¡äº†å…¶åæ„å»ºCSSOMè§„åˆ™æ ‘ï¼Œæ•´ä¸ªè§£æè¿›ç¨‹å¿…é¡»ç­‰å¾…JSçš„æ‰§è¡Œå®Œæˆæ‰èƒ½ç»§ç»­å®Œæˆã€‚

CSSé˜»å¡æ¸²æŸ“ï¼šç”±äºCSSOMè´Ÿè´£å­˜å‚¨æ¸²æŸ“ä¿¡æ¯ï¼Œæµè§ˆå™¨å°±å¿…é¡»ä¿å­˜åœ¨åˆæˆæ¸²æŸ“æ ‘ä¹‹å‰ï¼ŒCSSOMæ˜¯å®Œå¤‡çš„ï¼Œè¿™ç§å®Œå¤‡æ˜¯æŒ‡æ‰€æœ‰çš„CSS(å†…è”ã€å¤–éƒ¨å¥½å†…éƒ¨)éƒ½å·²ç»ä¸‹è½½å®Œï¼Œå¹¶è§£æå®Œï¼Œåªæœ‰CSSOMå’ŒDOMçš„è§£æå®Œå…¨ç»“æŸï¼Œæµè§ˆå™¨æ‰ä¼šè¿›å…¥ä¸‹ä¸€æ­¥æ¸²æŸ“ã€‚

CSSé˜»å¡æ¸²æŸ“æ„å‘³ç€ï¼Œåœ¨CSSOMå®Œå¤‡å‰ï¼Œé¡µé¢å°†å¤„äºç™½å±çŠ¶æ€ã€‚å°†æ ·å¼æ”¾åœ¨``head``ä¸­ï¼Œå¯ä»¥ä¼˜å…ˆè§£æCSSï¼Œä¿è¯æ›´å¿«çš„é¦–æ¬¡æ¸²æŸ“ã€‚

å¦‚æœé¡µé¢æ²¡æœ‰ä»»ä½•æ ·å¼ï¼ŒCSSOMä¾ç„¶ä¼šç”Ÿæˆï¼Œé»˜è®¤ç”Ÿæˆçš„CSSOMè‡ªå¸¦æµè§ˆå™¨é»˜è®¤æ ·å¼ã€‚

è§£ædomåŒæ—¶æŸ¥æ‰¾CSSï¼Œæ‰€ä»¥å¦‚æœæ˜¯``div p{font-size: 16px}``ï¼Œä¼šå…ˆå¯»æ‰¾æ‰€æœ‰pæ ‡ç­¾å¹¶åˆ¤æ–­å®ƒçš„çˆ¶æ ‡ç­¾æ˜¯å¦ä¸º``div``ä¹‹åå†å†³å®šè¦ä¸è¦æ¸²æŸ“ã€‚æ‰€ä»¥å°½é‡ç”¨``id``æˆ–``class``ã€‚
#### å›æµå’Œé‡ç»˜ reflow and repaint
##### reflowè§¦å‘æœºåˆ¶
1. æ·»åŠ æˆ–åˆ é™¤å¯è§çš„DOMå…ƒç´ 
2. å…ƒç´ ä½ç½®æ”¹å˜ 
3. å…ƒç´ æœ¬èº«çš„å°ºå¯¸å‘ç”Ÿæ”¹å˜
4. å†…å®¹æ”¹å˜
5. é¡µé¢æ¸²æŸ“å™¨åˆå§‹åŒ–
6. æµè§ˆå™¨çª—å£å¤§å°å‘ç”Ÿæ”¹å˜
##### reflow å›æµ
å½“æµè§ˆå™¨å‘ç°å¸ƒå±€å˜åŒ–ï¼Œå°±ä¼šé‡æ–°æ¸²æŸ“ï¼Œå°±æ˜¯``reflow``,``reflow``ä¼šä»``html``è¿™ä¸ª``root frame``å¼€å§‹é€’å½’å¾€ä¸‹ã€‚
##### repaint é‡ç»˜
``repaint``æ˜¯å½“æˆ‘ä»¬æ”¹å˜å…ƒç´ çš„èƒŒæ™¯è‰²ã€æ–‡å­—é¢œè‰²ã€è¾¹æ¡†é¢œè‰²ç­‰ç­‰ä¸å½±å“å®ƒå‘¨å›´æˆ–å†…éƒ¨å¸ƒå±€çš„å±æ€§æ—¶ï¼Œå±å¹•çš„ä¸€éƒ¨åˆ†éœ€è¦é‡ç”»ï¼Œä½†å…ƒç´ çš„å‡ ä½•å°ºå¯¸å’Œä½ç½®æ²¡æœ‰å‘ç”Ÿæ”¹å˜ã€‚
reflow å¿…å®šä¼šå¼•èµ· repaintã€‚            
``display:none``ä¼šè§¦å‘``reflow``ã€‚          
``visibility:hidden``åªä¼šè§¦å‘repaintã€‚        

reflow æˆ– repaintå¯èƒ½ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œç§¯æ”’ä¸€æ‰¹ååœ¨ç»Ÿä¸€æ‰§è¡Œ-> å¼‚æ­¥reflowæˆ–å¢é‡å¼‚æ­¥reflow



#### å‡å°‘å›æµæˆ–é‡ç»˜çš„è§¦å‘æ¬¡æ•°
* ç”¨``transform``åšå˜å½¢å’Œä½ç§»å¯ä»¥å‡å°‘reflow
* é¿å…é€ä¸ªä¿®æ”¹èŠ‚ç‚¹æ ·å¼ï¼Œå°½é‡ä¸€æ¬¡æ€§ä¿®æ”¹
* ä½¿ç”¨``DocumentFragment``å°†éœ€è¦å¤šæ¬¡ä¿®æ”¹çš„DOMå…ƒç´ ç¼“å­˜ï¼Œæœ€åä¸€æ¬¡æ€§``append``åˆ°çœŸå®çš„DOMä¸­æ¸²æŸ“
* å¯ä»¥å°†éœ€è¦å¤šæ¬¡ä¿®æ”¹çš„DOMå…ƒç´ è®¾ç½®``display:none``ï¼Œ
* é¿å…å¤šæ¬¡è¯»å–æŸäº›å±æ€§
* é€šè¿‡ç»å¯¹ä½ç§»å°†å¤æ‚çš„èŠ‚ç‚¹å…ƒç´ è„±ç¦»æ–‡æ¡£æµï¼Œå½¢æˆæ–°çš„Render Layerï¼Œé™ä½å›æµæˆæœ¬ã€‚
#### ä¼˜åŒ–
1. æœ€å°åŒ–é‡ç»˜å’Œé‡æ’
2. æ‰¹é‡ä¿®æ”¹DOM
  * è®©è¯¥å…ƒç´ è„±ç¦»æ–‡æ¡£æµ
  * å¯¹å…¶è¿›è¡Œå¤šé‡æ”¹å˜
  * å°†å…ƒç´ å¸¦å›æ–‡æ¡£
å…·ä½“æ“ä½œï¼š 
1 éšè—å…ƒç´ ï¼Œè¿›è¡Œä¿®æ”¹ååœ¨æ˜¾ç¤º
~~~
let ul = document.querySelector("#mylist");
ul.style.display = "none";
appendNode(ul, data);
ul.style.display = "block";
~~~
2 ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µåˆ›å»ºä¸€ä¸ªå­æ ‘ï¼Œç„¶ååœ¨æ‹·è´åˆ°æ–‡æ¡£ä¸­
~~~
let fragment = document.createDocumentFragment();
appendNode(fragmnt, data);
ul.appendChild(fragment);
~~~
3 å°†åŸå§‹å…ƒç´ æ‹·è´åˆ°ä¸€ä¸ªç‹¬ç«‹çš„èŠ‚ç‚¹ä¸­ï¼Œæ“ä½œè¿™ä¸ªèŠ‚ç‚¹ï¼Œç„¶åè¦†ç›–åŸå§‹å…ƒç´ 
~~~
let old = document.querySelector("#mylist");
let clone = old.cloneNode(true);
appendNode(clone, data);
old.parentNode.replaceChild(clone, old);
~~~
3. ç¼“å­˜å¸ƒå±€ä¿¡æ¯
## å‚è€ƒåšå®¢ï¼š
[æµè§ˆå™¨æ¸²æŸ“åŸç†ä¸è¿‡ç¨‹](http://jianshu.com/p/e6252dc9be32x)