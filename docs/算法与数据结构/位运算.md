# 位运算

## 什么是运算符？

运算符就是用来进行各种运算的符号。就像我们日常生活中使用的加减乘除符号一样。

### 常见的运算符类型

1. **算术运算符**：用于数学计算

   - `+` 加法：`3 + 2 = 5`
   - `-` 减法：`5 - 2 = 3`
   - `*` 乘法：`3 * 2 = 6`
   - `/` 除法：`6 / 2 = 3`
   - `%` 取余：`5 % 2 = 1`

2. **比较运算符**：用于比较大小

   - `>` 大于：`5 > 3` 为真
   - `<` 小于：`3 < 5` 为真
   - `==` 等于：`5 == 5` 为真
   - `>=` 大于等于
   - `<=` 小于等于

3. **逻辑运算符**：用于逻辑判断

   - `&&` 与：两个条件都为真时结果才为真
   - `||` 或：两个条件有一个为真时结果就为真
   - `!` 非：取反

4. **位运算符**：直接对二进制位进行操作（本文重点）

## 什么是位运算？

位运算就是直接对数字的二进制位进行操作的运算。要理解位运算，首先需要了解二进制。

## 二进制基础

### 什么是二进制？

我们平时使用的是十进制（0-9），而计算机内部使用的是二进制（只有 0 和 1）。

**十进制转二进制示例：**

```
十进制 5 = 二进制 101
解释：
  101 (二进制)
= 1×2² + 0×2¹ + 1×2⁰
= 1×4  + 0×2  + 1×1
= 4 + 0 + 1
= 5 (十进制)
```

**更多示例：**

| 十进制 | 二进制 | 计算过程      |
| ------ | ------ | ------------- |
| 0      | 0000   | 0             |
| 1      | 0001   | 1             |
| 2      | 0010   | 2             |
| 3      | 0011   | 2 + 1 = 3     |
| 4      | 0100   | 4             |
| 5      | 0101   | 4 + 1 = 5     |
| 6      | 0110   | 4 + 2 = 6     |
| 7      | 0111   | 4 + 2 + 1 = 7 |
| 8      | 1000   | 8             |
| 9      | 1001   | 8 + 1 = 9     |
| 10     | 1010   | 8 + 2 = 10    |

## 位运算符详解

### 1. 按位与（AND）运算符：`&`

**规则：** 两个位都是 1 时，结果才是 1，否则是 0

**口诀：** 一假则假（有一个是 0，结果就是 0）

**示例：**

```
  5 & 3
= 0101 & 0011
  ----
  0001 = 1

逐位分析：
第1位: 1 & 1 = 1
第2位: 0 & 1 = 0
第3位: 1 & 0 = 0
第4位: 0 & 0 = 0
结果: 0001 = 1
```

**真值表：**

| A   | B   | A & B |
| --- | --- | ----- |
| 0   | 0   | 0     |
| 0   | 1   | 0     |
| 1   | 0   | 0     |
| 1   | 1   | 1     |

**代码示例：**

```javascript
console.log(5 & 3); // 输出: 1
console.log(12 & 10); // 输出: 8
// 12 = 1100
// 10 = 1010
//      ----
//      1000 = 8
```

### 2. 按位或（OR）运算符：`|`

**规则：** 两个位只要有一个是 1，结果就是 1

**口诀：** 一真则真（有一个是 1，结果就是 1）

**示例：**

```
  5 | 3
= 0101 | 0011
  ----
  0111 = 7

逐位分析：
第1位: 1 | 1 = 1
第2位: 0 | 1 = 1
第3位: 1 | 0 = 1
第4位: 0 | 0 = 0
结果: 0111 = 7
```

**真值表：**

| A   | B   | A \| B |
| --- | --- | ------ |
| 0   | 0   | 0      |
| 0   | 1   | 1      |
| 1   | 0   | 1      |
| 1   | 1   | 1      |

**代码示例：**

```javascript
console.log(5 | 3); // 输出: 7
console.log(12 | 10); // 输出: 14
// 12 = 1100
// 10 = 1010
//      ----
//      1110 = 14
```

### 3. 按位异或（XOR）运算符：`^`

**规则：** 两个位不同时结果为 1，相同时结果为 0

**口诀：** 相同为假，不同为真

**示例：**

```
  5 ^ 3
= 0101 ^ 0011
  ----
  0110 = 6

逐位分析：
第1位: 1 ^ 1 = 0 (相同)
第2位: 0 ^ 1 = 1 (不同)
第3位: 1 ^ 0 = 1 (不同)
第4位: 0 ^ 0 = 0 (相同)
结果: 0110 = 6
```

**真值表：**

| A   | B   | A ^ B |
| --- | --- | ----- |
| 0   | 0   | 0     |
| 0   | 1   | 1     |
| 1   | 0   | 1     |
| 1   | 1   | 0     |

**代码示例：**

```javascript
console.log(5 ^ 3); // 输出: 6
console.log(12 ^ 10); // 输出: 6
// 12 = 1100
// 10 = 1010
//      ----
//      0110 = 6
```

**异或的特殊性质：**

```javascript
// 性质1: 任何数和 0 异或等于它本身
5 ^ 0 = 5

// 性质2: 任何数和自己异或等于 0
5 ^ 5 = 0

// 性质3: 异或满足交换律和结合律
a ^ b ^ c = a ^ c ^ b = b ^ a ^ c

// 应用：不用临时变量交换两个数
let a = 5, b = 3;
a = a ^ b;  // a = 5 ^ 3 = 6
b = a ^ b;  // b = 6 ^ 3 = 5
a = a ^ b;  // a = 6 ^ 5 = 3
// 现在 a = 3, b = 5
```

### 4. 按位非（NOT）运算符：`~`

**规则：** 对每一位取反，0 变 1，1 变 0

**示例：**

```
  ~5
= ~0101
= 1010
```

**注意：** 在 JavaScript 中，数字是以 32 位有符号整数存储的，所以：

```javascript
console.log(~5); // 输出: -6
// 因为:
// 5  = 00000000000000000000000000000101
// ~5 = 11111111111111111111111111111010 = -6 (补码表示)
```

**快速记忆公式：** `~n = -(n + 1)`

```javascript
~5 = -6
~0 = -1
~(-1) = 0
```

### 5. 左移运算符：`<<`

**规则：** 将二进制位向左移动指定位数，右边用 0 补充

**效果：** 左移 n 位相当于乘以 2^n

**示例：**

```
  5 << 1
= 0101 << 1
= 1010 = 10

  5 << 2
= 0101 << 2
= 10100 = 20
```

**代码示例：**

```javascript
console.log(5 << 1); // 输出: 10  (5 × 2¹ = 10)
console.log(5 << 2); // 输出: 20  (5 × 2² = 20)
console.log(5 << 3); // 输出: 40  (5 × 2³ = 40)
console.log(3 << 4); // 输出: 48  (3 × 2⁴ = 48)
```

### 6. 右移运算符：`>>`

**规则：** 将二进制位向右移动指定位数，左边用符号位补充

**效果：** 右移 n 位相当于除以 2^n（向下取整）

**示例：**

```
  5 >> 1
= 0101 >> 1
= 0010 = 2

  5 >> 2
= 0101 >> 2
= 0001 = 1
```

**代码示例：**

```javascript
console.log(5 >> 1); // 输出: 2  (5 ÷ 2¹ = 2.5 → 2)
console.log(5 >> 2); // 输出: 1  (5 ÷ 2² = 1.25 → 1)
console.log(20 >> 2); // 输出: 5  (20 ÷ 2² = 5)
console.log(8 >> 1); // 输出: 4  (8 ÷ 2¹ = 4)
```

### 7. 无符号右移运算符：`>>>`

**规则：** 将二进制位向右移动指定位数，左边用 0 补充（不考虑符号）

**示例：**

```javascript
console.log(5 >>> 1); // 输出: 2
console.log(-5 >>> 1); // 输出: 2147483645
// 负数的无符号右移会得到很大的正数
```

## 位运算的实际应用

### 1. 判断奇偶性

```javascript
// 传统方法
function isOdd(n) {
  return n % 2 === 1;
}

// 位运算方法（更快）
function isOddBit(n) {
  return (n & 1) === 1; // 最后一位是1则为奇数
}

console.log(isOddBit(5)); // true (奇数)
console.log(isOddBit(6)); // false (偶数)
```

**原理：** 奇数的二进制最后一位一定是 1，偶数最后一位一定是 0

```
5 = 0101  (最后一位是 1，奇数)
6 = 0110  (最后一位是 0，偶数)
```

### 2. 乘以 2 的幂次

```javascript
// 传统方法
let n = 5;
n = n * 2; // 10
n = n * 4; // 40
n = n * 8; // 320

// 位运算方法（更快）
let m = 5;
m = m << 1; // 10 (乘以 2¹)
m = m << 2; // 40 (乘以 2²)
m = m << 3; // 320 (乘以 2³)
```

### 3. 除以 2 的幂次

```javascript
// 传统方法
let n = 20;
n = Math.floor(n / 2); // 10
n = Math.floor(n / 4); // 2

// 位运算方法（更快）
let m = 20;
m = m >> 1; // 10 (除以 2¹)
m = m >> 2; // 2  (除以 2²)
```

### 4. 判断 2 的幂次

```javascript
// 判断一个数是否是 2 的幂次（1, 2, 4, 8, 16, 32...）
function isPowerOfTwo(n) {
  return n > 0 && (n & (n - 1)) === 0;
}

console.log(isPowerOfTwo(8)); // true
console.log(isPowerOfTwo(16)); // true
console.log(isPowerOfTwo(10)); // false
```

**原理：** 2 的幂次的二进制只有一个 1

```
8  = 1000
7  = 0111
8 & 7 = 0000

10 = 1010
9  = 1001
10 & 9 = 1000 (不等于0，所以不是2的幂次)
```

### 5. 交换两个变量（不用临时变量）

```javascript
let a = 5,
  b = 3;

// 传统方法
let temp = a;
a = b;
b = temp;

// 位运算方法（不需要临时变量）
a = a ^ b; // a = 5 ^ 3
b = a ^ b; // b = (5 ^ 3) ^ 3 = 5
a = a ^ b; // a = (5 ^ 3) ^ 5 = 3
```

### 6. 获取二进制中 1 的个数

```javascript
function countOnes(n) {
  let count = 0;
  while (n) {
    n = n & (n - 1); // 每次消除最右边的1
    count++;
  }
  return count;
}

console.log(countOnes(7)); // 3 (0111 有3个1)
console.log(countOnes(15)); // 4 (1111 有4个1)
console.log(countOnes(8)); // 1 (1000 有1个1)
```

**原理：** `n & (n-1)` 会消除 n 最右边的 1

```
7  = 0111
6  = 0110
7 & 6 = 0110 (消除了一个1)

6  = 0110
5  = 0101
6 & 5 = 0100 (又消除了一个1)
```

### 7. 权限系统设计

位运算常用于权限管理系统：

```javascript
// 定义权限（每个权限占一位）
const READ = 1; // 0001 - 读权限
const WRITE = 2; // 0010 - 写权限
const DELETE = 4; // 0100 - 删除权限
const EXECUTE = 8; // 1000 - 执行权限

// 给用户赋予多个权限（使用 | 运算）
let userPermission = READ | WRITE | DELETE; // 0111

// 检查是否有某个权限（使用 & 运算）
function hasPermission(user, permission) {
  return (user & permission) === permission;
}

console.log(hasPermission(userPermission, READ)); // true
console.log(hasPermission(userPermission, WRITE)); // true
console.log(hasPermission(userPermission, EXECUTE)); // false

// 添加权限（使用 | 运算）
userPermission = userPermission | EXECUTE; // 1111

// 删除权限（使用 & ~ 运算）
userPermission = userPermission & ~WRITE; // 1101

// 切换权限（使用 ^ 运算）
userPermission = userPermission ^ EXECUTE; // 0101
```

### 8. 找出数组中唯一的单独数字

```javascript
// 问题：数组中除了一个数字出现一次，其他都出现两次，找出这个数
function findSingle(arr) {
  let result = 0;
  for (let num of arr) {
    result ^= num; // 相同的数异或为0，最后剩下的就是单独的数
  }
  return result;
}

console.log(findSingle([1, 2, 3, 2, 1])); // 3
console.log(findSingle([4, 1, 2, 1, 2])); // 4
```

**原理：**

- `a ^ a = 0`（相同的数异或为 0）
- `a ^ 0 = a`（任何数和 0 异或等于它本身）
- 所以成对的数会相互抵消，剩下单独的那个

### 9. 获取某一位的值

```javascript
// 获取数字 n 的第 k 位（从右往左，从0开始）
function getBit(n, k) {
  return (n >> k) & 1;
}

console.log(getBit(5, 0)); // 1 (5 = 0101, 第0位是1)
console.log(getBit(5, 1)); // 0 (5 = 0101, 第1位是0)
console.log(getBit(5, 2)); // 1 (5 = 0101, 第2位是1)
```

### 10. 设置某一位为 1

```javascript
// 将数字 n 的第 k 位设置为 1
function setBit(n, k) {
  return n | (1 << k);
}

console.log(setBit(5, 1)); // 7
// 5 = 0101
// 设置第1位为1
// 7 = 0111
```

### 11. 清除某一位（设置为 0）

```javascript
// 将数字 n 的第 k 位清除（设置为0）
function clearBit(n, k) {
  return n & ~(1 << k);
}

console.log(clearBit(7, 1)); // 5
// 7 = 0111
// 清除第1位
// 5 = 0101
```

## 位运算的优势

1. **速度快**：位运算是 CPU 直接支持的操作，比算术运算快
2. **节省空间**：可以用一个整数存储多个布尔值
3. **代码简洁**：某些算法用位运算实现更简洁

## 位运算的注意事项

1. **可读性**：位运算虽然快，但代码可读性较差，需要添加注释
2. **适用场景**：不是所有情况都适合用位运算，要根据实际需求选择
3. **调试困难**：位运算的逻辑比较抽象，调试时需要转换成二进制思考

## 练习题

### 基础练习

1. 计算以下表达式的结果：

   - `6 & 3`
   - `6 | 3`
   - `6 ^ 3`
   - `~6`
   - `6 << 1`
   - `6 >> 1`

2. 将十进制数 13 转换为二进制

3. 写一个函数判断一个数是否是偶数（使用位运算）

### 进阶练习

4. 写一个函数，给定一个整数，返回它的二进制表示中有多少个 1

5. 写一个函数，反转一个整数的二进制位（例如：5 的二进制是 101，反转后是 101）

6. 实现一个简单的权限系统，包含增删改查四种权限

## 参考答案

```javascript
// 1. 表达式计算
console.log(6 & 3); // 2  (0110 & 0011 = 0010)
console.log(6 | 3); // 7  (0110 | 0011 = 0111)
console.log(6 ^ 3); // 5  (0110 ^ 0011 = 0101)
console.log(~6); // -7
console.log(6 << 1); // 12 (6 × 2 = 12)
console.log(6 >> 1); // 3  (6 ÷ 2 = 3)

// 2. 十进制转二进制
// 13 = 1101

// 3. 判断偶数
function isEven(n) {
  return (n & 1) === 0;
}

// 4. 统计二进制中1的个数
function countOnes(n) {
  let count = 0;
  while (n) {
    n = n & (n - 1);
    count++;
  }
  return count;
}

// 5. 反转二进制位（32位）
function reverseBits(n) {
  let result = 0;
  for (let i = 0; i < 32; i++) {
    result = (result << 1) | (n & 1);
    n >>= 1;
  }
  return result;
}

// 6. 权限系统
const Permission = {
  CREATE: 1, // 0001
  READ: 2, // 0010
  UPDATE: 4, // 0100
  DELETE: 8, // 1000
};

class PermissionSystem {
  constructor() {
    this.permission = 0;
  }

  // 添加权限
  grant(perm) {
    this.permission |= perm;
  }

  // 移除权限
  revoke(perm) {
    this.permission &= ~perm;
  }

  // 检查权限
  has(perm) {
    return (this.permission & perm) === perm;
  }

  // 切换权限
  toggle(perm) {
    this.permission ^= perm;
  }
}

// 使用示例
const ps = new PermissionSystem();
ps.grant(Permission.READ | Permission.WRITE);
console.log(ps.has(Permission.READ)); // true
console.log(ps.has(Permission.DELETE)); // false
```

## 总结

位运算是一种直接操作二进制位的运算方式，主要包括：

- **&（与）**：都为 1 才为 1
- **|（或）**：有 1 就为 1
- **^（异或）**：不同为 1，相同为 0
- **~（非）**：取反
- **<<（左移）**：乘以 2 的幂次
- **>>（右移）**：除以 2 的幂次

掌握位运算可以：

- 提高程序运行效率
- 实现一些巧妙的算法
- 优化空间使用
- 设计权限系统等

建议多做练习，培养二进制思维方式！
