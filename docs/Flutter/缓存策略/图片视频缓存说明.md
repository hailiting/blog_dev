# å›¾ç‰‡ã€è§†é¢‘å’Œè¯­éŸ³ç¼“å­˜æœºåˆ¶è¯´æ˜

## æ¦‚è¿°

æœ¬åº”ç”¨å®ç°äº†å®Œå–„çš„å›¾ç‰‡å’Œè§†é¢‘ç¼“å­˜æœºåˆ¶ï¼Œ**å¹¶éæ¯æ¬¡éƒ½é‡æ–°åŠ è½½**ï¼Œè€Œæ˜¯ä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼Œæå‡åŠ è½½é€Ÿåº¦å’Œç”¨æˆ·ä½“éªŒï¼ŒåŒæ—¶å‡å°‘ç½‘ç»œæµé‡æ¶ˆè€—ã€‚

âš ï¸ **æ³¨æ„ï¼š** è¯­éŸ³æ¶ˆæ¯ç›®å‰**æ²¡æœ‰æ˜¾å¼çš„ç¼“å­˜æœºåˆ¶**ï¼Œæ¯æ¬¡æ’­æ”¾æ¥æ”¶åˆ°çš„è¯­éŸ³æ¶ˆæ¯éƒ½éœ€è¦ä»ç½‘ç»œåŠ è½½ã€‚

---

## ä¸€ã€å›¾ç‰‡ç¼“å­˜æœºåˆ¶

### 1.1 ç¼“å­˜å®ç°æ–¹å¼

åº”ç”¨ä½¿ç”¨äº†ä¸¤ç§ä¸»è¦çš„å›¾ç‰‡åŠ è½½å’Œç¼“å­˜æ–¹å¼ï¼š

#### æ–¹å¼ä¸€ï¼šExtendedImageï¼ˆä¸»è¦ä½¿ç”¨ï¼‰

**ä½ç½®ï¼š** `openim_common/lib/src/utils/image_util.dart`

**å®ç°ç»†èŠ‚ï¼š**

- ä½¿ç”¨ `extended_image` åŒ…ï¼ˆç‰ˆæœ¬ 8.2.0ï¼‰
- `ExtendedImage.network()` é…ç½®äº† `cacheRawData: true`ï¼Œä¼šç¼“å­˜åŸå§‹å›¾ç‰‡æ•°æ®
- æ”¯æŒå†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜
- å¯ä»¥è®¾ç½® `cacheWidth` å’Œ `cacheHeight` æ¥ä¼˜åŒ–ç¼“å­˜å¤§å°ï¼ˆç‰¹åˆ«æ˜¯åœ¨ä½å†…å­˜æ¨¡å¼ä¸‹ï¼‰

ğŸ” extended_image é»˜è®¤ä½¿ç”¨ DefaultCacheManagerï¼ˆæ¥è‡ª flutter_cache_managerï¼‰ æ¥å¤„ç†ç£ç›˜ç¼“å­˜ã€‚
ç¼“å­˜æ–‡ä»¶å®é™…å­˜å‚¨åœ¨ App çš„ç§æœ‰æ²™ç›’ç›®å½•ä¸­ï¼Œä¸åŒå¹³å°è·¯å¾„ä¸åŒï¼šğŸ“± Androidï¼š/data/user/0/ä½ çš„åŒ…å/cache/libCachedImageData/

**å…³é”®é…ç½®ï¼š**

```dart
ExtendedImage.network(
  url,
  cacheRawData: true,  // å¯ç”¨åŸå§‹æ•°æ®ç¼“å­˜
  clearMemoryCacheWhenDispose: false,  // é‡Šæ”¾æ—¶ä¸æ¸…é™¤å†…å­˜ç¼“å­˜
  clearMemoryCacheIfFailed: true,  // åŠ è½½å¤±è´¥æ—¶æ¸…é™¤å†…å­˜ç¼“å­˜
  cacheWidth: ...,  // å¯é€‰çš„ç¼“å­˜å®½åº¦
  cacheHeight: ..., // å¯é€‰çš„ç¼“å­˜é«˜åº¦
)
```

**ä½¿ç”¨åœºæ™¯ï¼š**

- èŠå¤©ä¸­çš„å›¾ç‰‡
- å¤´åƒå›¾ç‰‡
- æœ‹å‹åœˆ/å·¥ä½œåœˆçš„å›¾ç‰‡
- å¤§éƒ¨åˆ†ç½‘ç»œå›¾ç‰‡åŠ è½½

#### æ–¹å¼äºŒï¼šCachedNetworkImageï¼ˆé’±åŒ…æ¨¡å—ä½¿ç”¨ï¼‰

**ä½ç½®ï¼š** `lib/wallet/widget/image_load_view.dart`

**å®ç°ç»†èŠ‚ï¼š**

- ä½¿ç”¨ `cached_network_image` åŒ…ï¼ˆç‰ˆæœ¬ 3.3.1ï¼‰
- è‡ªåŠ¨ç®¡ç†å›¾ç‰‡ç¼“å­˜ï¼ŒåŒ…æ‹¬å†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜
- æä¾›äº†å ä½å›¾å’Œé”™è¯¯å›¾ç‰‡çš„å›è°ƒ

**å…³é”®é…ç½®ï¼š**

```dart
CachedNetworkImage(
  imageUrl: path,
  placeholder: ...,  // åŠ è½½ä¸­çš„å ä½å›¾
  errorWidget: ...,  // åŠ è½½å¤±è´¥çš„é”™è¯¯å›¾ç‰‡
  fit: fit,
)
```

**ä½¿ç”¨åœºæ™¯ï¼š**

- é’±åŒ…æ¨¡å—çš„å›¾ç‰‡åŠ è½½
- Token å›¾æ ‡
- DApp å›¾æ ‡
- NFT å›¾ç‰‡

### 1.2 å›¾ç‰‡é¢„åŠ è½½æœºåˆ¶

**ä½ç½®ï¼š** `openim_common/lib/src/widgets/photo_browser.dart`

åœ¨å›¾ç‰‡æµè§ˆå™¨ä¸­å®ç°äº†é¢„åŠ è½½æœºåˆ¶ï¼š

- å½“å‰å›¾ç‰‡åŠ è½½æ—¶ï¼Œä¼šé¢„åŠ è½½å‰ä¸€å¼ å’Œåä¸€å¼ å›¾ç‰‡
- ä½¿ç”¨ `precacheImage()` æ–¹æ³•æå‰å°†å›¾ç‰‡åŠ è½½åˆ°ç¼“å­˜
- é¿å…ç”¨æˆ·æ»‘åŠ¨æ—¶ç­‰å¾…åŠ è½½

```dart
void _preloadImage(int index) {
  // é¢„åŠ è½½ç›¸é‚»çš„å›¾ç‰‡
  imageProvider = ExtendedNetworkImageProvider(url, cache: true);
  precacheImage(imageProvider, context);
}
```

### 1.3 ç¼“å­˜ç‰¹æ€§

âœ… **æœ‰ç¼“å­˜ï¼š** å›¾ç‰‡ä¼šè¢«ç¼“å­˜åˆ°å†…å­˜å’Œç£ç›˜  
âœ… **æ™ºèƒ½åŠ è½½ï¼š** ä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼Œç¼“å­˜ä¸å­˜åœ¨æˆ–è¿‡æœŸæ—¶æ‰ä»ç½‘ç»œåŠ è½½  
âœ… **å†…å­˜ä¼˜åŒ–ï¼š** æ”¯æŒä½å†…å­˜æ¨¡å¼ä¸‹çš„å°ºå¯¸é™åˆ¶ç¼“å­˜  
âœ… **å¤±è´¥å¤„ç†ï¼š** åŠ è½½å¤±è´¥æ—¶è‡ªåŠ¨æ¸…é™¤é”™è¯¯çš„å†…å­˜ç¼“å­˜

---

## äºŒã€è§†é¢‘ç¼“å­˜æœºåˆ¶

### 2.1 ç¼“å­˜å®ç°æ–¹å¼

**ä½ç½®ï¼š** `openim_common/lib/src/widgets/chat/chat_video_player_view.dart`

åº”ç”¨ä½¿ç”¨äº† `flutter_cache_manager` åŒ…ï¼ˆç‰ˆæœ¬ 3.3.0ï¼‰æ¥ç®¡ç†è§†é¢‘ç¼“å­˜ï¼Œå¹¶å®ç°äº†ä¸“é—¨çš„ `CachedVideoControllerService` æœåŠ¡ç±»ã€‚

### 2.2 è§†é¢‘ç¼“å­˜æµç¨‹

#### æ ¸å¿ƒé€»è¾‘ï¼ˆCachedVideoControllerServiceï¼‰

```dart
class CachedVideoControllerService {
  final BaseCacheManager _cacheManager;

  Future<VideoPlayerController> getVideo(String videoUrl) async {
    // 1. é¦–å…ˆæ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨
    final file = await getCacheFile(videoUrl);

    if (file == null) {
      // 2. ç¼“å­˜ä¸å­˜åœ¨ï¼Œå¯åŠ¨åå°ä¸‹è½½å¹¶åŒæ—¶ä»ç½‘ç»œåŠ è½½
      unawaited(_cacheManager.downloadFile(videoUrl));
      return VideoPlayerController.networkUrl(...);  // ä»ç½‘ç»œåŠ è½½
    } else {
      // 3. ç¼“å­˜å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨æœ¬åœ°æ–‡ä»¶
      return VideoPlayerController.file(file);  // ä»ç¼“å­˜åŠ è½½
    }
  }
}
```

**å·¥ä½œæµç¨‹ï¼š**

1. **æ£€æŸ¥ç¼“å­˜ï¼š** æ’­æ”¾è§†é¢‘å‰ï¼Œå…ˆæ£€æŸ¥æœ¬åœ°ç¼“å­˜æ–‡ä»¶æ˜¯å¦å­˜åœ¨
2. **æœ‰ç¼“å­˜ï¼š** å¦‚æœç¼“å­˜å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨æœ¬åœ°æ–‡ä»¶æ’­æ”¾ï¼Œ**æ— éœ€ç½‘ç»œè¯·æ±‚**
3. **æ— ç¼“å­˜ï¼š** å¦‚æœç¼“å­˜ä¸å­˜åœ¨ï¼š
   - ç«‹å³ä»ç½‘ç»œåŠ è½½è§†é¢‘å¹¶å¼€å§‹æ’­æ”¾ï¼ˆä¸ç­‰å¾…ä¸‹è½½å®Œæˆï¼‰
   - åŒæ—¶å¯åŠ¨åå°ä¸‹è½½ï¼Œä¿å­˜åˆ°ç¼“å­˜ä¾›ä¸‹æ¬¡ä½¿ç”¨

### 2.3 è§†é¢‘ç¼“å­˜ä½¿ç”¨åœºæ™¯

#### åœºæ™¯ä¸€ï¼šèŠå¤©è§†é¢‘æ’­æ”¾

- **æ–‡ä»¶ï¼š** `openim_common/lib/src/widgets/chat/chat_video_player_view.dart`
- **ç¼“å­˜ç®¡ç†å™¨ï¼š** `DefaultCacheManager()`
- **è¡Œä¸ºï¼š** æ’­æ”¾å‰æ£€æŸ¥ç¼“å­˜ï¼Œæœ‰ç¼“å­˜ç›´æ¥æ’­æ”¾ï¼Œæ— ç¼“å­˜è¾¹ä¸‹è½½è¾¹æ’­æ”¾

#### åœºæ™¯äºŒï¼šè§†é¢‘é¢„è§ˆæ’­æ”¾

- **æ–‡ä»¶ï¼š** `openim_common/lib/src/widgets/photo_browser.dart` (VideoPlayerView)
- **ç¼“å­˜ç®¡ç†å™¨ï¼š** `DefaultCacheManager()`
- **è¡Œä¸ºï¼š** åŒæ ·å…ˆæ£€æŸ¥ç¼“å­˜ï¼ŒåŒæ—¶å¯åŠ¨åå°ä¸‹è½½

#### åœºæ™¯ä¸‰ï¼šå·¥ä½œåœˆè§†é¢‘é¢„è§ˆ

- **æ–‡ä»¶ï¼š** `openim_working_circle/lib/src/pages/work_moments_list/preview_video/preview_video_view.dart`
- **ç¼“å­˜ç®¡ç†å™¨ï¼š** `DefaultCacheManager()`
- **è¡Œä¸ºï¼š** ç»Ÿä¸€çš„ç¼“å­˜æœºåˆ¶

### 2.4 è§†é¢‘ç¼“å­˜ç‰¹æ€§

âœ… **æœ‰ç¼“å­˜ï¼š** è§†é¢‘ä¼šè¢«ç¼“å­˜åˆ°æœ¬åœ°ç£ç›˜  
âœ… **ä¼˜å…ˆæœ¬åœ°ï¼š** ç¼“å­˜å­˜åœ¨æ—¶ç›´æ¥ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ï¼Œæ— éœ€ç½‘ç»œ  
âœ… **è¾¹ä¸‹è¾¹æ’­ï¼š** æ— ç¼“å­˜æ—¶ç«‹å³ä»ç½‘ç»œåŠ è½½ï¼Œä¸é˜»å¡æ’­æ”¾  
âœ… **åå°ä¸‹è½½ï¼š** é¦–æ¬¡æ’­æ”¾æ—¶å¯åŠ¨åå°ä¸‹è½½ï¼Œä¸‹æ¬¡æ’­æ”¾ä½¿ç”¨ç¼“å­˜

---

## ä¸‰ã€è¯­éŸ³ç¼“å­˜æœºåˆ¶

### 3.1 å½“å‰å®ç°æ–¹å¼

**ä½ç½®ï¼š** `lib/pages/chat/chat_logic.dart`

åº”ç”¨ä½¿ç”¨ `just_audio` åŒ…ï¼ˆç‰ˆæœ¬ 0.9.36ï¼‰æ¥æ’­æ”¾è¯­éŸ³æ¶ˆæ¯ï¼Œä½†**ç›®å‰æ²¡æœ‰å®ç°è¯­éŸ³æ–‡ä»¶çš„ç¼“å­˜æœºåˆ¶**ã€‚

### 3.2 è¯­éŸ³æ’­æ”¾æµç¨‹

#### æ ¸å¿ƒé€»è¾‘ï¼ˆ\_initVoiceSourceï¼‰

```dart
Future<bool> _initVoiceSource(Message message) async {
  bool isReceived = message.sendID != OpenIM.iMManager.userID;
  String? path = message.soundElem?.soundPath;
  String? url = message.soundElem?.sourceUrl;
  bool isExistSource = false;
  if (isReceived) {
    // æ¥æ”¶åˆ°çš„è¯­éŸ³æ¶ˆæ¯ï¼šç›´æ¥ä½¿ç”¨ç½‘ç»œURLæ’­æ”¾
    if (null != url && url.trim().isNotEmpty) {
      isExistSource = true;
      _audioPlayer.setUrl(url);  // ç›´æ¥ä»ç½‘ç»œåŠ è½½ï¼Œæ— ç¼“å­˜
    }
  } else {
    // è‡ªå·±å‘é€çš„è¯­éŸ³æ¶ˆæ¯ï¼šä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ–‡ä»¶
    bool existFile = false;
    if (path != null && path.trim().isNotEmpty) {
      var file = File(path);
      existFile = await file.exists();
    }
    if (existFile) {
      isExistSource = true;
      _audioPlayer.setFilePath(path!);  // ä½¿ç”¨æœ¬åœ°å½•åˆ¶æ–‡ä»¶
    } else if (null != url && url.trim().isNotEmpty) {
      isExistSource = true;
      _audioPlayer.setUrl(url);  // æœ¬åœ°æ–‡ä»¶ä¸å­˜åœ¨æ—¶ä½¿ç”¨ç½‘ç»œURL
    }
  }
  return isExistSource;
}
```

**å·¥ä½œæµç¨‹ï¼š**

1. **æ¥æ”¶åˆ°çš„è¯­éŸ³æ¶ˆæ¯ï¼š**

   - ç›´æ¥ä½¿ç”¨ `_audioPlayer.setUrl(url)` ä»ç½‘ç»œ URL æ’­æ”¾
   - **æ²¡æœ‰ä¸‹è½½å’Œç¼“å­˜æœºåˆ¶**
   - æ¯æ¬¡æ’­æ”¾éƒ½éœ€è¦ä»ç½‘ç»œåŠ è½½

2. **è‡ªå·±å‘é€çš„è¯­éŸ³æ¶ˆæ¯ï¼š**
   - ä¼˜å…ˆä½¿ç”¨æœ¬åœ°å½•åˆ¶æ–‡ä»¶ï¼ˆ`soundPath`ï¼‰
   - å¦‚æœæœ¬åœ°æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨ç½‘ç»œ URL

### 3.3 è¯­éŸ³æ¶ˆæ¯ç´¢å¼•ç¼“å­˜

è™½ç„¶è¯­éŸ³æ–‡ä»¶æœ¬èº«æ²¡æœ‰ç¼“å­˜ï¼Œä½†åº”ç”¨å®ç°äº†**è¯­éŸ³æ¶ˆæ¯ç´¢å¼•ç¼“å­˜**ï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾è¯­éŸ³æ¶ˆæ¯ï¼š

**ä½ç½®ï¼š** `lib/pages/chat/chat_logic.dart`

```dart
// æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜è¯­éŸ³æ¶ˆæ¯ç´¢å¼•
final _voiceMessageIndexes = <int>{};

/// æ„å»ºè¯­éŸ³æ¶ˆæ¯ç´¢å¼•ç¼“å­˜
void _buildVoiceMessageIndexes() {
  _voiceMessageIndexes.clear();
  for (int i = 0; i < messageList.length; i++) {
    final message = messageList[i];
    if (message.contentType == MessageType.voice) {
      _voiceMessageIndexes.add(i);
    } else if (message.contentType == MessageType.custom &&
        _isCustomVoiceMessage(message)) {
      _voiceMessageIndexes.add(i);
    }
  }
}
```

**åŠŸèƒ½ï¼š**

- ç¼“å­˜æ‰€æœ‰è¯­éŸ³æ¶ˆæ¯åœ¨æ¶ˆæ¯åˆ—è¡¨ä¸­çš„ç´¢å¼•ä½ç½®
- ç”¨äºå¿«é€ŸæŸ¥æ‰¾ä¸‹ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå®ç°è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½
- **æ³¨æ„ï¼š** è¿™åªæ˜¯ç´¢å¼•ç¼“å­˜ï¼Œä¸æ˜¯è¯­éŸ³æ–‡ä»¶æœ¬èº«çš„ç¼“å­˜

### 3.4 è¯­éŸ³ç¼“å­˜ç‰¹æ€§

âŒ **æ— æ–‡ä»¶ç¼“å­˜ï¼š** æ¥æ”¶åˆ°çš„è¯­éŸ³æ¶ˆæ¯æ¯æ¬¡æ’­æ”¾éƒ½ä»ç½‘ç»œåŠ è½½  
âœ… **æœ¬åœ°æ–‡ä»¶ï¼š** è‡ªå·±å‘é€çš„è¯­éŸ³æ¶ˆæ¯ä½¿ç”¨æœ¬åœ°å½•åˆ¶æ–‡ä»¶  
âœ… **ç´¢å¼•ç¼“å­˜ï¼š** æœ‰è¯­éŸ³æ¶ˆæ¯ç´¢å¼•ç¼“å­˜ï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾  
âš ï¸ **æ€§èƒ½å½±å“ï¼š** é‡å¤æ’­æ”¾åŒä¸€è¯­éŸ³æ¶ˆæ¯ä¼šé‡å¤ä¸‹è½½ï¼Œæ¶ˆè€—æµé‡

### 3.5 ä¸å›¾ç‰‡/è§†é¢‘çš„å¯¹æ¯”

| ç‰¹æ€§           | å›¾ç‰‡      | è§†é¢‘  | è¯­éŸ³                  |
| -------------- | --------- | ----- | --------------------- |
| æ˜¯å¦æœ‰ç¼“å­˜     | âœ… æ˜¯     | âœ… æ˜¯ | âŒ å¦                 |
| æ˜¯å¦æ¯æ¬¡éƒ½åŠ è½½ | âŒ å¦     | âŒ å¦ | âœ… æ˜¯                 |
| ç¼“å­˜æ–¹å¼       | å†…å­˜+ç£ç›˜ | ç£ç›˜  | æ—                     |
| æœ¬åœ°æ–‡ä»¶æ”¯æŒ   | âœ… æ˜¯     | âœ… æ˜¯ | âœ… æ˜¯ï¼ˆä»…è‡ªå·±å‘é€çš„ï¼‰ |

---

## å››ã€ç¼“å­˜ç®¡ç†é…ç½®

### 4.1 å›¾ç‰‡ç¼“å­˜é…ç½®

**å†…å­˜ç¼“å­˜ï¼š**

- Flutter æ¡†æ¶è‡ªåŠ¨ç®¡ç†å›¾ç‰‡å†…å­˜ç¼“å­˜
- å¯é€šè¿‡ `ImageCache` é…ç½®æœ€å¤§ç¼“å­˜å¤§å°
- é»˜è®¤ç¼“å­˜ç­–ç•¥ï¼šæœ€è¿‘ä½¿ç”¨çš„å›¾ç‰‡ä¿æŒåœ¨å†…å­˜ä¸­

**ç£ç›˜ç¼“å­˜ï¼š**

- `ExtendedImage` ä½¿ç”¨å…¶å†…ç½®çš„ç£ç›˜ç¼“å­˜æœºåˆ¶
- `CachedNetworkImage` ä½¿ç”¨ `flutter_cache_manager` è¿›è¡Œç£ç›˜ç¼“å­˜
- ç¼“å­˜ä½ç½®ï¼šåº”ç”¨ç¼“å­˜ç›®å½•

### 4.2 è§†é¢‘ç¼“å­˜é…ç½®

**ä½¿ç”¨çš„ç¼“å­˜ç®¡ç†å™¨ï¼š** `DefaultCacheManager()`

**é»˜è®¤é…ç½®ï¼š**

- **ç¼“å­˜ä½ç½®ï¼š** åº”ç”¨ç¼“å­˜ç›®å½•ï¼ˆå¯é€šè¿‡ `getApplicationCacheDirectory()` è·å–ï¼‰
- **ç¼“å­˜ç­–ç•¥ï¼š** ä½¿ç”¨ `flutter_cache_manager` çš„é»˜è®¤ç­–ç•¥
- **æ¸…ç†æœºåˆ¶ï¼š** éµå¾ªç³»ç»Ÿç¼“å­˜æ¸…ç†ç­–ç•¥ï¼Œåº”ç”¨å¸è½½æ—¶è‡ªåŠ¨æ¸…ç†

### 4.3 è¯­éŸ³ç¼“å­˜é…ç½®

**å½“å‰çŠ¶æ€ï¼š** âŒ **æœªå®ç°è¯­éŸ³æ–‡ä»¶ç¼“å­˜**

**ä½¿ç”¨çš„æ’­æ”¾å™¨ï¼š** `just_audio` åŒ…ï¼ˆç‰ˆæœ¬ 0.9.36ï¼‰

**æ’­æ”¾æ–¹å¼ï¼š**

- æ¥æ”¶åˆ°çš„è¯­éŸ³ï¼šç›´æ¥ä½¿ç”¨ `AudioPlayer.setUrl(url)` ä»ç½‘ç»œæ’­æ”¾
- è‡ªå·±å‘é€çš„è¯­éŸ³ï¼šä½¿ç”¨æœ¬åœ°æ–‡ä»¶è·¯å¾„ `AudioPlayer.setFilePath(path)`

**å»ºè®®ä¼˜åŒ–ï¼š**

- å‚è€ƒè§†é¢‘ç¼“å­˜æœºåˆ¶ï¼Œä½¿ç”¨ `flutter_cache_manager` ä¸‹è½½å¹¶ç¼“å­˜è¯­éŸ³æ–‡ä»¶
- æ’­æ”¾å‰å…ˆæ£€æŸ¥ç¼“å­˜ï¼Œæœ‰ç¼“å­˜åˆ™ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ï¼Œæ— ç¼“å­˜åˆ™ä¸‹è½½å¹¶ç¼“å­˜

### 4.4 ç¼“å­˜æ¸…ç†

**è‡ªåŠ¨æ¸…ç†ï¼š**

- ç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶ï¼ŒFlutter ä¼šè‡ªåŠ¨æ¸…ç†å†…å­˜ç¼“å­˜
- åº”ç”¨å¸è½½æ—¶ï¼Œç¼“å­˜ç›®å½•ä¼šè¢«ç³»ç»Ÿæ¸…ç†

**æ‰‹åŠ¨æ¸…ç†ï¼ˆå¦‚éœ€è¦ï¼‰ï¼š**

- å¯ä»¥é€šè¿‡ `DefaultCacheManager().emptyCache()` æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
- å¯ä»¥é€šè¿‡æ–‡ä»¶ç³»ç»Ÿ API åˆ é™¤ç¼“å­˜ç›®å½•

---

## äº”ã€æ€»ç»“

### å›¾ç‰‡ç¼“å­˜æ€»ç»“

| ç‰¹æ€§           | çŠ¶æ€  | è¯´æ˜                               |
| -------------- | ----- | ---------------------------------- |
| æ˜¯å¦æœ‰ç¼“å­˜     | âœ… æ˜¯ | åŒæ—¶æ”¯æŒå†…å­˜å’Œç£ç›˜ç¼“å­˜             |
| æ˜¯å¦æ¯æ¬¡éƒ½åŠ è½½ | âŒ å¦ | ä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼Œç¼“å­˜æœªå‘½ä¸­æ—¶æ‰åŠ è½½   |
| ç¼“å­˜æ–¹å¼       | å¤šç§  | ExtendedImage + CachedNetworkImage |
| é¢„åŠ è½½æœºåˆ¶     | âœ… æœ‰ | å›¾ç‰‡æµè§ˆå™¨é¢„åŠ è½½ç›¸é‚»å›¾ç‰‡           |

### è§†é¢‘ç¼“å­˜æ€»ç»“

| ç‰¹æ€§           | çŠ¶æ€                | è¯´æ˜                             |
| -------------- | ------------------- | -------------------------------- |
| æ˜¯å¦æœ‰ç¼“å­˜     | âœ… æ˜¯               | ä½¿ç”¨ç£ç›˜ç¼“å­˜                     |
| æ˜¯å¦æ¯æ¬¡éƒ½åŠ è½½ | âŒ å¦               | æœ‰ç¼“å­˜ç›´æ¥æ’­æ”¾ï¼Œæ— ç¼“å­˜è¾¹ä¸‹è¾¹æ’­   |
| ç¼“å­˜æ–¹å¼       | DefaultCacheManager | ç»Ÿä¸€çš„ç¼“å­˜ç®¡ç†å™¨                 |
| åå°ä¸‹è½½       | âœ… æ”¯æŒ             | é¦–æ¬¡æ’­æ”¾æ—¶åå°ç¼“å­˜ï¼Œä¸‹æ¬¡ç›´æ¥ä½¿ç”¨ |

### è¯­éŸ³ç¼“å­˜æ€»ç»“

| ç‰¹æ€§           | çŠ¶æ€    | è¯´æ˜                                           |
| -------------- | ------- | ---------------------------------------------- |
| æ˜¯å¦æœ‰ç¼“å­˜     | âŒ å¦   | æ¥æ”¶åˆ°çš„è¯­éŸ³æ¶ˆæ¯æ²¡æœ‰æ–‡ä»¶ç¼“å­˜                   |
| æ˜¯å¦æ¯æ¬¡éƒ½åŠ è½½ | âœ… æ˜¯   | æ¯æ¬¡æ’­æ”¾æ¥æ”¶åˆ°çš„è¯­éŸ³éƒ½ä»ç½‘ç»œåŠ è½½               |
| ç¼“å­˜æ–¹å¼       | æ—       | æœªå®ç°è¯­éŸ³æ–‡ä»¶ç¼“å­˜æœºåˆ¶                         |
| æœ¬åœ°æ–‡ä»¶æ”¯æŒ   | âœ… éƒ¨åˆ† | ä»…è‡ªå·±å‘é€çš„è¯­éŸ³ä½¿ç”¨æœ¬åœ°æ–‡ä»¶                   |
| ç´¢å¼•ç¼“å­˜       | âœ… æœ‰   | æœ‰è¯­éŸ³æ¶ˆæ¯ç´¢å¼•ç¼“å­˜ï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾ï¼ˆéæ–‡ä»¶ç¼“å­˜ï¼‰ |

### å…³é”®ç»“è®º

1. **å›¾ç‰‡å’Œè§†é¢‘éƒ½æœ‰ç¼“å­˜æœºåˆ¶ï¼Œå¹¶éæ¯æ¬¡éƒ½é‡æ–°åŠ è½½**
2. **å›¾ç‰‡ç¼“å­˜ï¼š** å†…å­˜ + ç£ç›˜åŒé‡ç¼“å­˜ï¼ŒåŠ è½½é€Ÿåº¦æå¿«
3. **è§†é¢‘ç¼“å­˜ï¼š** ç£ç›˜ç¼“å­˜ï¼Œé¦–æ¬¡æ’­æ”¾åå†æ¬¡æ’­æ”¾æ— éœ€ç½‘ç»œ
4. **è¯­éŸ³ç¼“å­˜ï¼š** âš ï¸ **ç›®å‰æ²¡æœ‰ç¼“å­˜æœºåˆ¶**ï¼Œæ¥æ”¶åˆ°çš„è¯­éŸ³æ¯æ¬¡æ’­æ”¾éƒ½ä»ç½‘ç»œåŠ è½½
5. **æ™ºèƒ½åŠ è½½ï¼š** å›¾ç‰‡å’Œè§†é¢‘ä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼Œæå‡ç”¨æˆ·ä½“éªŒï¼Œå‡å°‘æµé‡æ¶ˆè€—
6. **é¢„åŠ è½½ä¼˜åŒ–ï¼š** å›¾ç‰‡æµè§ˆå™¨æ”¯æŒé¢„åŠ è½½ï¼Œæå‡æµè§ˆæµç•…åº¦
7. **ä¼˜åŒ–å»ºè®®ï¼š** è¯­éŸ³æ¶ˆæ¯å¯ä»¥å‚è€ƒè§†é¢‘ç¼“å­˜æœºåˆ¶ï¼Œå®ç°è¯­éŸ³æ–‡ä»¶ç¼“å­˜åŠŸèƒ½

---

## å…­ã€ç›¸å…³æŠ€æœ¯æ ˆ

- **å›¾ç‰‡ç¼“å­˜ï¼š**

  - `extended_image: ^8.2.0`
  - `cached_network_image: ^3.3.1`

- **è§†é¢‘ç¼“å­˜ï¼š**

  - `flutter_cache_manager: ^3.3.0`
  - `video_player: ^2.9.1`

- **è¯­éŸ³æ’­æ”¾ï¼š**

  - `just_audio: ^0.9.36` - éŸ³é¢‘æ’­æ”¾å™¨ï¼ˆæ— ç¼“å­˜æœºåˆ¶ï¼‰
  - `audio_session: ^0.1.18` - éŸ³é¢‘ä¼šè¯ç®¡ç†

- **ç›¸å…³æ–‡ä»¶ä½ç½®ï¼š**
  - `openim_common/lib/src/utils/image_util.dart` - å›¾ç‰‡å·¥å…·ç±»
  - `openim_common/lib/src/widgets/chat/chat_video_player_view.dart` - è§†é¢‘æ’­æ”¾å™¨
  - `lib/pages/chat/chat_logic.dart` - è¯­éŸ³æ’­æ”¾é€»è¾‘ï¼ˆ`_initVoiceSource` æ–¹æ³•ï¼‰
  - `lib/wallet/widget/image_load_view.dart` - é’±åŒ…å›¾ç‰‡ç»„ä»¶

---

## ä¸ƒã€ç¼“å­˜ä¼˜åŒ–ï¼ˆæ–°å¢ï¼‰

### 6.1 å›¾ç‰‡ç¼“å­˜ä¼˜åŒ–

**ä¼˜åŒ–å†…å®¹ï¼š**

- âœ… **å†…å­˜ç¼“å­˜å¤§å°é™åˆ¶** - å·²é…ç½®æœ€å¤§ 200MB å†…å­˜ç¼“å­˜
- âœ… **ç¼“å­˜æ•°é‡é™åˆ¶** - å·²é…ç½®æœ€å¤šç¼“å­˜ 1000 å¼ å›¾ç‰‡
- ğŸ“ **ä½ç½®ï¼š** `openim_common/lib/src/config.dart` çš„ `_configureImageCache()` æ–¹æ³•

**é…ç½®è¯¦æƒ…ï¼š**

```dart
// åœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨é…ç½®
imageCache.maximumSize = 1000;        // æœ€å¤§ç¼“å­˜å›¾ç‰‡æ•°
imageCache.maximumSizeBytes = 200 * 1024 * 1024;  // æœ€å¤§ç¼“å­˜å¤§å°200MB
```

### 6.2 è§†é¢‘ç¼“å­˜ä¼˜åŒ–

**ä¼˜åŒ–å†…å®¹ï¼š**

- âœ… **ç»Ÿä¸€è§†é¢‘ç¼“å­˜ç®¡ç†å™¨** - åˆ›å»ºäº† `CustomVideoCacheManager` ç±»
- âœ… **ç¼“å­˜ç®¡ç†å·¥å…·** - åˆ›å»ºäº† `CacheManagerUtil` ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç¼“å­˜
- ğŸ“ **ä½ç½®ï¼š**
  - `openim_common/lib/src/utils/video_cache_manager.dart`
  - `openim_common/lib/src/utils/cache_manager_util.dart`

**åŠŸèƒ½ç‰¹æ€§ï¼š**

- ç»Ÿä¸€çš„è§†é¢‘ç¼“å­˜ç®¡ç†æ¥å£
- æ”¯æŒè·å–ç¼“å­˜æ–‡ä»¶
- æ”¯æŒå¼‚æ­¥ä¸‹è½½åˆ°ç¼“å­˜
- æ”¯æŒæ¸…ç©ºç¼“å­˜

### 6.3 ç»Ÿä¸€ç¼“å­˜ç®¡ç†å·¥å…·

**åŠŸèƒ½ï¼š**

- âœ… **ç¼“å­˜å¤§å°ç»Ÿè®¡** - `getTotalCacheSize()` è·å–æ‰€æœ‰ç¼“å­˜æ€»å¤§å°
- âœ… **ç¼“å­˜æ¸…ç†** - `clearAllCache()` æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
- âœ… **è‡ªåŠ¨æ¸…ç†** - `autoCleanExpiredCache()` è¶…é™è‡ªåŠ¨æ¸…ç†
- âœ… **æ ¼å¼åŒ–æ˜¾ç¤º** - `formatCacheSize()` æ ¼å¼åŒ–ç¼“å­˜å¤§å°æ˜¾ç¤º

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```dart
// è·å–ç¼“å­˜æ€»å¤§å°
final size = await CacheManagerUtil.getTotalCacheSize();
print('ç¼“å­˜å¤§å°: ${CacheManagerUtil.formatCacheSize(size)}');

// æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
await CacheManagerUtil.clearAllCache();

// è‡ªåŠ¨æ¸…ç†ï¼ˆè¶…è¿‡500MBæ—¶ï¼‰
await CacheManagerUtil.autoCleanExpiredCache(maxSizeBytes: 500 * 1024 * 1024);
```

### 6.4 ä¼˜åŒ–æ•ˆæœ

âœ… **å†…å­˜æ§åˆ¶** - å›¾ç‰‡ç¼“å­˜é™åˆ¶åœ¨ 200MB ä»¥å†…ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º  
âœ… **å­˜å‚¨æ§åˆ¶** - å¯é€šè¿‡å·¥å…·ç±»ç›‘æ§å’Œæ¸…ç†ç¼“å­˜  
âœ… **ç»Ÿä¸€ç®¡ç†** - æ‰€æœ‰ç¼“å­˜é€šè¿‡ç»Ÿä¸€æ¥å£ç®¡ç†  
âœ… **è‡ªåŠ¨æ¸…ç†** - æ”¯æŒè¶…é™è‡ªåŠ¨æ¸…ç†æœºåˆ¶

---

## å…«ã€åç»­ä¼˜åŒ–å»ºè®®

### 7.1 å›¾ç‰‡é¢„åŠ è½½ä¼˜åŒ–

- å¯æ‰©å±•é¢„åŠ è½½æ•°é‡ï¼ˆå½“å‰å‰åå„ 1 å¼ ï¼Œå¯æ‰©å±•åˆ°å‰åå„ 2-3 å¼ ï¼‰
- æ ¹æ®ç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´é¢„åŠ è½½ç­–ç•¥
- æ ¹æ®æ»‘åŠ¨æ–¹å‘ä¼˜å…ˆé¢„åŠ è½½

### 7.2 è§†é¢‘åŠ è½½ç­–ç•¥ä¼˜åŒ–

âœ… **å·²ä¼˜åŒ–ï¼š** è§†é¢‘é¦–æ¬¡åŠ è½½å¡é¡¿é—®é¢˜å·²è§£å†³

**ä¼˜åŒ–å†…å®¹ï¼š**

1. **æ™ºèƒ½åŠ è½½ç­–ç•¥**ï¼š

   - å°è§†é¢‘ï¼ˆ<10MBï¼‰ï¼šç­‰å¾…ä¸‹è½½å®Œæˆå†æ’­æ”¾ï¼Œé¿å…å¡é¡¿
   - å¤§è§†é¢‘ï¼ˆâ‰¥10MBï¼‰ï¼šè¾¹ä¸‹è¾¹æ’­ï¼ŒåŒæ—¶åå°ç¼“å­˜
   - è‡ªåŠ¨æ£€æµ‹è§†é¢‘å¤§å°ï¼Œé€‰æ‹©æœ€ä¼˜åŠ è½½æ–¹å¼

2. **ç¼“å†²ä¼˜åŒ–**ï¼š

   - ç½‘ç»œè§†é¢‘æ’­æ”¾å‰ç­‰å¾…ç¼“å†²ï¼ˆè‡³å°‘ 2 ç§’æˆ– 10%è§†é¢‘æ—¶é•¿ï¼‰
   - é¿å…ç¼“å†²ä¸è¶³å¯¼è‡´çš„æ’­æ”¾å¡é¡¿
   - æœ€å¤šç­‰å¾… 5 ç§’ï¼Œè¶…æ—¶åˆ™ç›´æ¥æ’­æ”¾

3. **ç¼“å†²çŠ¶æ€æ˜¾ç¤º**ï¼š

   - å®æ—¶ç›‘å¬è§†é¢‘ç¼“å†²çŠ¶æ€
   - ç¼“å†²æ—¶æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
   - ç¼“å†²å®Œæˆåè‡ªåŠ¨éšè—æŒ‡ç¤ºå™¨

4. **å®ç°ä½ç½®**ï¼š
   - `openim_common/lib/src/widgets/chat/chat_video_player_view.dart`
   - `CachedVideoControllerService.getVideo()` æ–¹æ³•
   - `_ChatVideoPlayerViewState._waitForBuffer()` æ–¹æ³•

**ä¼˜åŒ–æ•ˆæœï¼š**

- âœ… **å°è§†é¢‘æµç•…æ’­æ”¾** - ä¸‹è½½å®Œæˆåå†æ’­æ”¾ï¼Œæ— å¡é¡¿
- âœ… **å¤§è§†é¢‘æ™ºèƒ½ç¼“å†²** - ç­‰å¾…è¶³å¤Ÿç¼“å†²å†æ’­æ”¾ï¼Œå‡å°‘å¡é¡¿
- âœ… **ç”¨æˆ·ä½“éªŒæå‡** - æ˜¾ç¤ºç¼“å†²çŠ¶æ€ï¼Œç”¨æˆ·äº†è§£åŠ è½½è¿›åº¦
- âœ… **ç½‘ç»œä¼˜åŒ–** - æ ¹æ®è§†é¢‘å¤§å°é€‰æ‹©æœ€ä¼˜ç­–ç•¥ï¼ŒèŠ‚çœæµé‡

### 7.3 ç¼“å­˜ç›‘æ§å’Œç»Ÿè®¡

- æ·»åŠ ç¼“å­˜ä½¿ç”¨æƒ…å†µçš„å®æ—¶ç›‘æ§
- åœ¨è®¾ç½®é¡µé¢æ˜¾ç¤ºç¼“å­˜å¤§å°
- æä¾›ç”¨æˆ·æ‰‹åŠ¨æ¸…ç†ç¼“å­˜çš„å…¥å£

### 7.4 è¯­éŸ³ç¼“å­˜ä¼˜åŒ–å»ºè®®

**å½“å‰é—®é¢˜ï¼š**

- æ¥æ”¶åˆ°çš„è¯­éŸ³æ¶ˆæ¯æ¯æ¬¡æ’­æ”¾éƒ½ä»ç½‘ç»œåŠ è½½ï¼Œæ²¡æœ‰ç¼“å­˜æœºåˆ¶
- é‡å¤æ’­æ”¾åŒä¸€è¯­éŸ³æ¶ˆæ¯ä¼šé‡å¤ä¸‹è½½ï¼Œæ¶ˆè€—æµé‡

**å»ºè®®æ–¹æ¡ˆï¼š**

1. **å‚è€ƒè§†é¢‘ç¼“å­˜æœºåˆ¶**ï¼Œä½¿ç”¨ `flutter_cache_manager` å®ç°è¯­éŸ³æ–‡ä»¶ç¼“å­˜
2. **æ’­æ”¾å‰æ£€æŸ¥ç¼“å­˜**ï¼š
   - å…ˆæ£€æŸ¥æœ¬åœ°ç¼“å­˜æ–‡ä»¶æ˜¯å¦å­˜åœ¨
   - æœ‰ç¼“å­˜ï¼šç›´æ¥ä½¿ç”¨æœ¬åœ°æ–‡ä»¶æ’­æ”¾
   - æ— ç¼“å­˜ï¼šä»ç½‘ç»œä¸‹è½½å¹¶ç¼“å­˜ï¼ŒåŒæ—¶å¼€å§‹æ’­æ”¾
3. **ç»Ÿä¸€ç¼“å­˜ç®¡ç†**ï¼š
   - å°†è¯­éŸ³ç¼“å­˜çº³å…¥ `CacheManagerUtil` ç»Ÿä¸€ç®¡ç†
   - æ”¯æŒè¯­éŸ³ç¼“å­˜å¤§å°ç»Ÿè®¡å’Œæ¸…ç†
4. **å®ç°ç¤ºä¾‹**ï¼ˆå‚è€ƒè§†é¢‘ç¼“å­˜ï¼‰ï¼š

   ```dart
   Future<String?> getVoiceCachePath(String voiceUrl) async {
     final file = await cacheManager.getFileFromCache(voiceUrl);
     return file?.file.path;
   }

   Future<void> cacheVoiceFile(String voiceUrl) async {
     await cacheManager.downloadFile(voiceUrl);
   }
   ```

è¯¦ç»†ä¼˜åŒ–æ–¹æ¡ˆè¯·å‚è€ƒï¼š`å›¾ç‰‡è§†é¢‘ç¼“å­˜ä¼˜åŒ–æ–¹æ¡ˆ.md`

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´ï¼š** 2024 å¹´  
**é€‚ç”¨ç‰ˆæœ¬ï¼š** å½“å‰ä»£ç åº“ç‰ˆæœ¬  
**æœ€åæ›´æ–°ï¼š** æ·»åŠ è¯­éŸ³ç¼“å­˜è¯´æ˜å’Œç¼“å­˜ä¼˜åŒ–å†…å®¹
