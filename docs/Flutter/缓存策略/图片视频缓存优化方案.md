# 图片和视频缓存优化方案

## 一、当前存在的问题

### 1.1 图片缓存优化点

- ❌ **未配置内存缓存大小限制** - 可能导致内存溢出
- ❌ **未设置缓存过期时间** - 缓存可能无限增长
- ❌ **预加载数量固定** - 只预加载前后各 1 张，可扩展
- ❌ **缓存清理策略缺失** - 没有自动清理机制

### 1.2 视频缓存优化点

- ❌ **使用默认缓存管理器** - 没有自定义配置（大小、过期时间）
- ❌ **边下边播体验不佳** - 首次播放可能卡顿
- ❌ **缓存大小无限制** - 可能占用大量存储空间
- ❌ **没有缓存监控** - 无法了解缓存使用情况

---

## 二、优化方案

### 2.1 图片缓存优化

#### 优化 1：配置图片内存缓存大小

**位置：** `openim_common/lib/src/config.dart`

**优化内容：**

- 配置 `ImageCache` 的最大图片数量（默认 1000）
- 配置 `ImageCache` 的最大内存大小（建议 200MB）
- 在应用初始化时设置

**预期效果：**

- 防止内存溢出
- 更可控的内存使用

#### 优化 2：图片预加载策略扩展

**位置：** `openim_common/lib/src/widgets/photo_browser.dart`

**优化内容：**

- 可配置预加载数量（当前前后各 1 张，可扩展到前后各 2-3 张）
- 根据网络状况动态调整预加载策略
- 添加预加载优先级（优先预加载当前方向）

**预期效果：**

- 更流畅的浏览体验
- 减少等待时间

### 2.2 视频缓存优化

#### 优化 3：自定义视频缓存管理器

**位置：** 新建 `openim_common/lib/src/utils/video_cache_manager.dart`

**优化内容：**

- 配置缓存最大大小（如 500MB）
- 设置缓存过期时间（如 30 天）
- 配置缓存清理策略（LRU）
- 监控缓存使用情况

**预期效果：**

- 控制缓存大小，避免占用过多存储
- 自动清理过期缓存
- 更好的缓存管理

#### 优化 4：视频加载策略优化

**位置：** `openim_common/lib/src/widgets/chat/chat_video_player_view.dart`

**优化内容：**

- 小视频（<10MB）等待下载完成再播放
- 大视频继续使用边下边播，但优化加载体验
- 添加下载进度显示

**预期效果：**

- 小视频播放更流畅，无卡顿
- 大视频加载体验更好

### 2.3 统一缓存管理

#### 优化 5：创建统一缓存管理工具

**位置：** 新建 `openim_common/lib/src/utils/cache_manager_util.dart`

**优化内容：**

- 统一管理图片和视频缓存
- 提供缓存统计接口
- 提供缓存清理接口
- 监控缓存大小，超限自动清理

**预期效果：**

- 统一的缓存管理接口
- 更好的缓存控制

---

## 三、具体实现方案

### 3.1 图片内存缓存配置

```dart
// 在 Config.init() 中添加
static Future init(Function() runApp) async {
  // ... 现有代码 ...

  // 配置图片内存缓存
  _configureImageCache();

  runApp();
}

static void _configureImageCache() {
  final imageCache = PaintingBinding.instance.imageCache;

  // 设置最大缓存图片数量（默认1000）
  imageCache.maximumSize = 1000;

  // 设置最大缓存大小（200MB，按字节计算）
  imageCache.maximumSizeBytes = 200 * 1024 * 1024;
}
```

### 3.2 自定义视频缓存管理器

```dart
class CustomVideoCacheManager {
  static BaseCacheManager? _cacheManager;

  static BaseCacheManager getInstance() {
    _cacheManager ??= CacheManager(
      Config(
        // 缓存目录名称
        'videoCache',
        // 最大缓存大小：500MB
        maxNrOfCacheObjects: 100,
        // 缓存过期时间：30天
        stalePeriod: const Duration(days: 30),
        // 缓存大小限制
        repo: JsonCacheInfoRepository(
          databaseName: 'videoCache.db',
        ),
        fileService: HttpFileService(),
      ),
    );
    return _cacheManager!;
  }
}
```

### 3.3 视频加载策略优化

```dart
Future<VideoPlayerController> getVideo(String videoUrl) async {
  final file = await getCacheFile(videoUrl);

  if (file == null) {
    // 检查视频大小
    final fileSize = await _getVideoSize(videoUrl);

    if (fileSize < 10 * 1024 * 1024) { // 小于10MB
      // 小视频：等待下载完成再播放
      final file = await _cacheManager.downloadFile(videoUrl);
      return VideoPlayerController.file(file.file);
    } else {
      // 大视频：边下边播
      unawaited(_cacheManager.downloadFile(videoUrl));
      return VideoPlayerController.networkUrl(...);
    }
  } else {
    return VideoPlayerController.file(file);
  }
}
```

### 3.4 统一缓存管理工具

```dart
class CacheManagerUtil {
  // 获取缓存总大小
  static Future<int> getTotalCacheSize() async {
    // 统计图片缓存大小
    // 统计视频缓存大小
    // 返回总和
  }

  // 清理所有缓存
  static Future<void> clearAllCache() async {
    // 清理图片缓存
    // 清理视频缓存
  }

  // 自动清理过期缓存
  static Future<void> autoCleanExpiredCache() async {
    // 检查缓存大小
    // 超限则清理LRU缓存
  }
}
```

---

## 四、优化效果预期

### 4.1 性能提升

- ✅ **内存使用更可控** - 图片缓存限制在 200MB 以内
- ✅ **存储空间控制** - 视频缓存限制在 500MB 以内
- ✅ **加载速度提升** - 优化的预加载策略
- ✅ **播放更流畅** - 小视频完整加载后再播放

### 4.2 用户体验提升

- ✅ **无内存溢出风险** - 配置了缓存上限
- ✅ **存储空间可控** - 自动清理过期缓存
- ✅ **浏览更流畅** - 扩展的预加载策略
- ✅ **播放体验更好** - 小视频无卡顿

### 4.3 维护性提升

- ✅ **统一管理** - 所有缓存统一管理
- ✅ **可监控** - 可查看缓存使用情况
- ✅ **可配置** - 所有参数可配置调整

---

## 五、实施步骤

1. **第一步：图片内存缓存配置**

   - 修改 `Config.init()` 方法
   - 添加图片缓存配置

2. **第二步：创建自定义视频缓存管理器**

   - 新建 `video_cache_manager.dart`
   - 配置缓存大小和过期时间

3. **第三步：优化视频加载策略**

   - 修改 `CachedVideoControllerService`
   - 实现小视频完整加载逻辑

4. **第四步：创建统一缓存管理工具**

   - 新建 `cache_manager_util.dart`
   - 实现缓存统计和清理功能

5. **第五步：扩展图片预加载**

   - 修改 `photo_browser.dart`
   - 支持可配置的预加载数量

6. **第六步：测试和调优**
   - 测试各种场景
   - 根据实际情况调整参数

---

## 六、注意事项

1. **缓存大小配置**

   - 根据应用实际使用情况调整
   - 考虑低端设备的限制
   - 预留一定缓冲空间

2. **缓存过期时间**

   - 图片缓存：建议 7-14 天
   - 视频缓存：建议 30 天
   - 可根据内容类型调整

3. **预加载策略**

   - WiFi 环境下可多预加载
   - 移动网络下减少预加载
   - 根据用户滑动方向调整

4. **兼容性**
   - 保持向后兼容
   - 渐进式优化
   - 提供配置开关

---

**文档版本：** v1.0  
**创建时间：** 2024 年  
**适用版本：** 当前代码库版本
